<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Scorely by AddedValue</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet" />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- papaparse, xlsx -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
      body { font-family: 'Inter', sans-serif; background: #fff; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const steps = [
        "Who are we looking for?",
        "Pre-filter (Round 1)",
        "Profile Summary Mapping",
        "Advanced Pre-filter (Round 2)",
        "Ranking",
        "Results Dashboard",
        "Settings"
      ];

      // System prompt for AI (used in all GPT calls)
      const SYSTEM_PROMPT = `
You are an expert technical recruiter. When evaluating a candidate profile, do not rely only on keywords. 
Infer strengths and fit from the candidate's experience, the companies they worked for, and their skills. 
If a candidate worked at a well-known startup or a leading tech company, this is a strong signal for both technical and personal strengths. 
The current and past companies should have a high weight in your assessment of their experience and abilities.
Always provide a short explanation for the score and category you assign.
`;

      // Auto-save/load wizard state to localStorage
      function usePersistentState(key, initial) {
        const [state, setState] = React.useState(() => {
          try {
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : initial;
          } catch {
            return initial;
          }
        });
        React.useEffect(() => {
          localStorage.setItem(key, JSON.stringify(state));
        }, [key, state]);
        return [state, setState];
      }

      // Step 1: Who are we looking for?
      function StepWhoAreWe({ data, setData }) {
        // Local state for save indicators
        const [saved, setSaved] = React.useState({});
        // Helper to update field and show Saved
        const handleSave = (field, value) => {
          setData(d => ({ ...d, [field]: value }));
          setSaved(s => ({ ...s, [field]: true }));
          setTimeout(() => setSaved(s => ({ ...s, [field]: false })), 1200);
        };

        // Industries and Education options
        const industries = ["SaaS", "Data", "Security", "Fintech", "AI", "Other"];
        const educationList = [
          "Hebrew University of Jerusalem",
          "Technion – Israel Institute of Technology",
          "Tel Aviv University",
          "Bar-Ilan University",
          "Ben-Gurion University of the Negev",
          "Weizmann Institute of Science",
          "Reichman University",
          "University of Haifa",
          "The Academic College of Tel‑Aviv‑Yaffo",
          "Not Relevant Institution"
        ];

        // Ranking weights
        const weightFields = [
          { key: "techFit", label: "Tech Fit" },
          { key: "experience", label: "Experience" },
          { key: "signals", label: "Signals" },
          { key: "startupFit", label: "Startup Fit" }
        ];

        // File upload helpers (Job Description, Ideal Profiles, Hot Signals, Target Companies)
        const handleFile = (field, e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = ev => {
            handleSave(field, ev.target.result);
          };
          reader.readAsText(file);
        };

        // Multi-select helpers
        const toggleMulti = (field, value) => {
          const arr = data[field] || [];
          if (arr.includes(value)) {
            handleSave(field, arr.filter(v => v !== value));
          } else {
            handleSave(field, [...arr, value]);
          }
        };

        // Add custom trait
        const [traitInput, setTraitInput] = React.useState("");
        const addTrait = () => {
          if (traitInput.trim()) {
            handleSave("customTraits", [...(data.customTraits || []), traitInput.trim()]);
            setTraitInput("");
          }
        };

        // Add custom education
        const [eduInput, setEduInput] = React.useState("");
        const addEdu = () => {
          if (eduInput.trim()) {
            handleSave("education", [...(data.education || []), eduInput.trim()]);
            setEduInput("");
          }
        };

        return (
          <form className="space-y-6">
            {/* Job Description */}
            <div>
              <label className="font-semibold flex items-center gap-2">Job Description
                <span className="text-gray-400 cursor-pointer" title="Paste or upload a job description. Will be truncated to 500 characters for AI.">?</span>
              </label>
              <textarea
                className="w-full border rounded p-2 mt-1"
                rows={3}
                maxLength={1000}
                value={data.jobDesc || ""}
                onChange={e => handleSave("jobDesc", e.target.value)}
                placeholder="Paste job description here..."
              />
              <div className="flex items-center gap-2 mt-1">
                <input type="file" accept=".txt,.pdf" onChange={e => handleFile("jobDesc", e)} />
                <span className="text-green-600 text-sm">{saved.jobDesc && "Saved"}</span>
              </div>
            </div>

            {/* Ideal Profiles */}
            <div>
              <label className="font-semibold flex items-center gap-2">Ideal Profiles (2 examples)
                <span className="text-gray-400 cursor-pointer" title="Upload or paste two top candidate profiles (HTML/Text or PDF)">?</span>
              </label>
              <div className="flex gap-4">
                {[0,1].map(i => (
                  <div key={i} className="flex-1">
                    <input
                      className="w-full border rounded p-2"
                      placeholder={`Paste profile #${i+1}...`}
                      value={data.idealProfiles?.[i] || ""}
                      onChange={e => {
                        const arr = data.idealProfiles ? [...data.idealProfiles] : ["",""];
                        arr[i] = e.target.value;
                        handleSave("idealProfiles", arr);
                      }}
                    />
                    <input type="file" accept=".txt,.pdf,.html" className="mt-1" onChange={e => {
                      const file = e.target.files[0];
                      if (!file) return;
                      const reader = new FileReader();
                      reader.onload = ev => {
                        const arr = data.idealProfiles ? [...data.idealProfiles] : ["",""];
                        arr[i] = ev.target.result;
                        handleSave("idealProfiles", arr);
                      };
                      reader.readAsText(file);
                    }} />
                    <span className="text-green-600 text-sm">{saved.idealProfiles && "Saved"}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* Target Companies */}
            <div>
              <label className="font-semibold flex items-center gap-2">Target Companies
                <span className="text-gray-400 cursor-pointer" title="Upload or enter a list of target companies.">?</span>
              </label>
              <textarea
                className="w-full border rounded p-2 mt-1"
                rows={2}
                value={data.targetCompanies || ""}
                onChange={e => handleSave("targetCompanies", e.target.value)}
                placeholder="Company1, Company2, ..."
              />
              <div className="flex items-center gap-2 mt-1">
                <input type="file" accept=".txt,.csv" onChange={e => handleFile("targetCompanies", e)} />
                <span className="text-green-600 text-sm">{saved.targetCompanies && "Saved"}</span>
              </div>
            </div>

            {/* Experience Range */}
            <div>
              <label className="font-semibold flex items-center gap-2">Range of Experience (years)
                <span className="text-gray-400 cursor-pointer" title="Set minimum and maximum years of experience.">?</span>
              </label>
              <div className="flex gap-2 items-center">
                <input type="number" min={0} max={50} className="border rounded p-1 w-20" value={data.expMin || ""} onChange={e => handleSave("expMin", e.target.value)} placeholder="Min" />
                <span>-</span>
                <input type="number" min={0} max={50} className="border rounded p-1 w-20" value={data.expMax || ""} onChange={e => handleSave("expMax", e.target.value)} placeholder="Max" />
                <span className="text-green-600 text-sm">{(saved.expMin || saved.expMax) && "Saved"}</span>
              </div>
            </div>

            {/* Industry Multi-select */}
            <div>
              <label className="font-semibold flex items-center gap-2">Industry
                <span className="text-gray-400 cursor-pointer" title="Select one or more industries.">?</span>
              </label>
              <div className="flex flex-wrap gap-2 mt-1">
                {industries.map(ind => (
                  <button
                    key={ind}
                    type="button"
                    className={`px-3 py-1 rounded border ${data.industry?.includes(ind) ? "bg-[#2196F3] text-white" : "bg-white text-gray-700"}`}
                    onClick={() => toggleMulti("industry", ind)}
                  >{ind}</button>
                ))}
                <input
                  className="border rounded p-1 ml-2"
                  placeholder="Custom"
                  value={data.industryCustom || ""}
                  onChange={e => handleSave("industryCustom", e.target.value)}
                />
              </div>
              <span className="text-green-600 text-sm">{saved.industry && "Saved"}</span>
            </div>

            {/* Education Multi-select */}
            <div>
              <label className="font-semibold flex items-center gap-2">Education
                <span className="text-gray-400 cursor-pointer" title="Select universities/colleges or add custom.">?</span>
              </label>
              <div className="flex flex-wrap gap-2 mt-1">
                {educationList.map(edu => (
                  <button
                    key={edu}
                    type="button"
                    className={`px-3 py-1 rounded border ${data.education?.includes(edu) ? "bg-[#EC407A] text-white" : "bg-white text-gray-700"}`}
                    onClick={() => toggleMulti("education", edu)}
                  >{edu}</button>
                ))}
                <input
                  className="border rounded p-1 ml-2"
                  placeholder="Custom"
                  value={eduInput}
                  onChange={e => setEduInput(e.target.value)}
                />
                <button type="button" className="px-2 py-1 bg-[#8BC34A] text-white rounded" onClick={addEdu}>Add</button>
              </div>
              <span className="text-green-600 text-sm">{saved.education && "Saved"}</span>
            </div>

            {/* Custom Traits */}
            <div>
              <label className="font-semibold flex items-center gap-2">Custom Traits
                <span className="text-gray-400 cursor-pointer" title="Add custom traits (e.g. proactive, team player)">?</span>
              </label>
              <div className="flex gap-2 mt-1">
                <input
                  className="border rounded p-1 flex-1"
                  placeholder="Type a trait..."
                  value={traitInput}
                  onChange={e => setTraitInput(e.target.value)}
                />
                <button type="button" className="px-2 py-1 bg-[#8BC34A] text-white rounded" onClick={addTrait}>Add Trait</button>
              </div>
              <div className="flex flex-wrap gap-2 mt-2">
                {(data.customTraits || []).map((t,i) => (
                  <span key={i} className="px-2 py-1 bg-gray-200 rounded">{t}</span>
                ))}
              </div>
              <span className="text-green-600 text-sm">{saved.customTraits && "Saved"}</span>
            </div>

            {/* Hot Signals */}
            <div>
              <label className="font-semibold flex items-center gap-2">Hot Signals
                <span className="text-gray-400 cursor-pointer" title="Upload or enter companies with layoffs, closures, or alerts.">?</span>
              </label>
              <textarea
                className="w-full border rounded p-2 mt-1"
                rows={2}
                value={data.hotSignals || ""}
                onChange={e => handleSave("hotSignals", e.target.value)}
                placeholder="Company1, Company2, ..."
              />
              <div className="flex items-center gap-2 mt-1">
                <input type="file" accept=".txt,.csv,.json" onChange={e => handleFile("hotSignals", e)} />
                <span className="text-green-600 text-sm">{saved.hotSignals && "Saved"}</span>
              </div>
            </div>

            {/* Ranking Weights */}
            <div>
              <label className="font-semibold flex items-center gap-2">Ranking Weights
                <span className="text-gray-400 cursor-pointer" title="Adjust the importance of each criterion.">?</span>
              </label>
              <div className="space-y-2 mt-2">
                {weightFields.map(w => (
                  <div key={w.key} className="flex items-center gap-2">
                    <span className="w-32">{w.label}</span>
                    <input
                      type="range"
                      min={0}
                      max={100}
                      value={data[w.key] || 0}
                      onChange={e => handleSave(w.key, Number(e.target.value))}
                      className="flex-1"
                    />
                    <span className="w-10 text-right">{data[w.key] || 0}%</span>
                  </div>
                ))}
                <button type="button" className="mt-2 px-4 py-1 bg-[#2196F3] text-white rounded" onClick={() => setSaved(s => ({ ...s, weights: true }))}>Save</button>
                <span className="text-green-600 text-sm ml-2">{saved.weights && "Saved"}</span>
              </div>
            </div>
          </form>
        );
      }

      // Step 2: Pre-filter (Round 1)
      function MappingModal({ headers, mapping, onSave, onClose }) {
        // ... existing code ...
      }

      function StepPreFilter({ data, setData }) {
        // ... existing code ...
        return (
          <div className="space-y-8">
            {/* File upload */}
            <div>
              <label className="font-semibold flex items-center gap-2">Upload Profiles File
                <span className="text-gray-400 cursor-pointer" title="Upload a CSV or XLSX file with candidate profiles. AI will detect headers for mapping.">?</span>
              </label>
              <input type="file" accept=".csv,.xlsx" className="mt-2" onChange={handleFile} />
              {fileName && <span className="ml-2 text-gray-600">{fileName}</span>}
              {showMapping && <MappingModal headers={headers} mapping={mapping} onSave={saveMapping} onClose={() => setShowMapping(false)} />}
              {headers.length > 0 && !showMapping && (
                <button className="ml-4 px-3 py-1 bg-[#2196F3] text-white rounded" title="Remap columns if the AI did not detect correctly" onClick={() => setShowMapping(true)}>Remap Columns</button>
              )}
              {headers.length > 0 && (
                <button className="ml-2 px-3 py-1 bg-[#8BC34A] text-white rounded" title="Run initial filtering on uploaded profiles" onClick={runFiltering}>Run Filtering</button>
              )}
              {(!rows.length && !filtered.length) && (
                <div className="text-gray-400 mt-4">No profiles uploaded yet. Please upload a CSV or XLSX file to begin.</div>
              )}
            </div>
            {/* ... existing code ... */}
          </div>
        );
      }

      // Step 3: Profile Summary Mapping
      function StepProfileSummary({ data, setData }) {
        // ... existing code ...
        return (
          <div className="space-y-6">
            <div>
              <label className="font-semibold flex items-center gap-2">Select columns for Profile Summary
                <span className="text-gray-400 cursor-pointer" title="Choose which columns to concatenate into the Profile Summary for AI analysis.">?</span>
              </label>
              {headers.length === 0 && (
                <div className="text-gray-400 mt-2">No profiles available. Please complete the previous step.</div>
              )}
              {/* ... existing code ... */}
            </div>
            <div className="bg-gray-50 border rounded p-4 mt-4">
              <div className="font-semibold mb-2">Sample Profile Summary</div>
              <div className="text-gray-700 min-h-[32px]">{sample || "No sample available. Please upload profiles and select columns."}</div>
            </div>
          </div>
        );
      }

      // Step 4: Advanced Pre-filter (Round 2)
      function StepAdvancedPreFilter({ data, setData }) {
        // State for required skills, titles, red flags, and status
        const [skills, setSkills] = React.useState(data.essentialSkills || []);
        const [skillInput, setSkillInput] = React.useState("");
        const [titles, setTitles] = React.useState(data.requiredTitles || []);
        const [titleInput, setTitleInput] = React.useState("");
        const [redFlags, setRedFlags] = React.useState(data.redFlags || []);
        const [status, setStatus] = React.useState({ passed: 0, skipped: 0, forwarded: 0 });
        const [saved, setSaved] = React.useState(false);
        const [filteredProfiles, setFilteredProfiles] = React.useState([]);

        const redFlagOptions = [
          "Instability",
          "Stagnation",
          "Enterprise-only",
          "Freelancer"
        ];

        // Add skill/title
        const addSkill = () => {
          if (skillInput.trim()) {
            setSkills(s => [...s, skillInput.trim()]);
            setSkillInput("");
          }
        };
        const addTitle = () => {
          if (titleInput.trim()) {
            setTitles(t => [...t, titleInput.trim()]);
            setTitleInput("");
          }
        };
        // Toggle red flag
        const toggleRedFlag = flag => {
          setRedFlags(rf => rf.includes(flag) ? rf.filter(f => f !== flag) : [...rf, flag]);
        };

        // Save selections
        const handleSave = () => {
          setData(d => ({ ...d, essentialSkills: skills, requiredTitles: titles, redFlags }));
          setSaved(true);
          setTimeout(() => setSaved(false), 1200);
        };

        // Simulate embedding-based filtering (placeholder for real AI logic)
        const runAdvancedFilter = () => {
          // For demo: randomly assign passed/skipped/forwarded
          const total = (data.profiles || []).length;
          const passed = Math.floor(total * 0.6);
          const skipped = Math.floor(total * 0.2);
          const forwarded = total - passed - skipped;
          setStatus({ passed, skipped, forwarded });
          setFilteredProfiles((data.profiles || []).slice(0, passed + forwarded));
          setData(d => ({ ...d, advancedFiltered: (data.profiles || []).slice(0, passed + forwarded) }));
        };

        return (
          <div className="space-y-8">
            {/* Title Matching */}
            <div>
              <label className="font-semibold flex items-center gap-2">Required Titles (synonyms)
                <span className="text-gray-400 cursor-pointer" title="Add job titles or synonyms to match using embeddings.">?</span>
              </label>
              <div className="flex gap-2 mt-1">
                <input
                  className="border rounded p-1 flex-1"
                  placeholder="Type a title..."
                  value={titleInput}
                  onChange={e => setTitleInput(e.target.value)}
                />
                <button type="button" className="px-2 py-1 bg-[#8BC34A] text-white rounded" onClick={addTitle}>Add Title</button>
              </div>
              <div className="flex flex-wrap gap-2 mt-2">
                {titles.map((t,i) => (
                  <span key={i} className="px-2 py-1 bg-gray-200 rounded">{t}</span>
                ))}
              </div>
            </div>

            {/* Essential Skills */}
            <div>
              <label className="font-semibold flex items-center gap-2">Essential Skills
                <span className="text-gray-400 cursor-pointer" title="Add required skills to match using embeddings.">?</span>
              </label>
              <div className="flex gap-2 mt-1">
                <input
                  className="border rounded p-1 flex-1"
                  placeholder="Type a skill..."
                  value={skillInput}
                  onChange={e => setSkillInput(e.target.value)}
                />
                <button type="button" className="px-2 py-1 bg-[#8BC34A] text-white rounded" onClick={addSkill}>Add Skill</button>
              </div>
              <div className="flex flex-wrap gap-2 mt-2">
                {skills.map((s,i) => (
                  <span key={i} className="px-2 py-1 bg-gray-200 rounded">{s}</span>
                ))}
              </div>
            </div>

            {/* Red Flags */}
            <div>
              <label className="font-semibold flex items-center gap-2">Red Flags
                <span className="text-gray-400 cursor-pointer" title="Select red flags that will disqualify profiles.">?</span>
              </label>
              <div className="flex flex-wrap gap-2 mt-2">
                {redFlagOptions.map(flag => (
                  <button
                    key={flag}
                    type="button"
                    className={`px-3 py-1 rounded border ${redFlags.includes(flag) ? "bg-[#EC407A] text-white" : "bg-white text-gray-700"}`}
                    onClick={() => toggleRedFlag(flag)}
                  >{flag}</button>
                ))}
              </div>
            </div>

            {/* Save and Run */}
            <div className="flex gap-2 mt-4">
              <button className="px-4 py-1 bg-[#2196F3] text-white rounded" onClick={handleSave}>Save</button>
              <span className="text-green-600 text-sm">{saved && "Saved"}</span>
              <button className="px-4 py-1 bg-[#8BC34A] text-white rounded" onClick={runAdvancedFilter}>Run Advanced Filter</button>
            </div>

            {/* Status Dashboard */}
            <div className="bg-white border rounded p-6 mt-4 flex flex-col gap-2">
              <div className="font-semibold mb-2">Status Dashboard</div>
              <div className="flex gap-8">
                <div>Passed: <span className="font-bold">{status.passed}</span></div>
                <div>Skipped: <span className="font-bold">{status.skipped}</span></div>
                <div>Forwarded to Ranking: <span className="font-bold">{status.forwarded}</span></div>
              </div>
              {(status.passed + status.skipped + status.forwarded === 0) && (
                <div className="text-gray-400 mt-2">No advanced filtering has been run yet. Please set criteria and click 'Run Advanced Filter'.</div>
              )}
            </div>
          </div>
        );
      }

      // Cost Tracking Utility
      async function trackCost(meta) {
        try {
          await fetch("https://script.google.com/a/macros/added-value.co.il/s/AKfycbzf3seMAhiM7N90ep_wvFSl04el-W6aVznRFwhcKbyHzYp4Y5-k8Qa1uU4pmlMO7mzx/exec", {
            method: "POST",
            body: JSON.stringify(meta),
            headers: { "Content-Type": "application/json" }
          });
        } catch (e) {
          // Silently ignore errors
        }
      }

      // Embedding and AI utilities
      // In-memory cache for embeddings
      const embeddingCache = {};

      // IndexedDB cache for embeddings
      function getDb() {
        return new Promise((resolve, reject) => {
          const req = window.indexedDB.open("scorely-embeddings", 1);
          req.onupgradeneeded = () => {
            req.result.createObjectStore("embeddings");
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = reject;
        });
      }
      async function getEmbeddingFromDb(key) {
        const db = await getDb();
        return new Promise((resolve, reject) => {
          const tx = db.transaction("embeddings", "readonly");
          const store = tx.objectStore("embeddings");
          const req = store.get(key);
          req.onsuccess = () => resolve(req.result);
          req.onerror = reject;
        });
      }
      async function setEmbeddingInDb(key, value) {
        const db = await getDb();
        return new Promise((resolve, reject) => {
          const tx = db.transaction("embeddings", "readwrite");
          const store = tx.objectStore("embeddings");
          const req = store.put(value, key);
          req.onsuccess = () => resolve();
          req.onerror = reject;
        });
      }

      // Fetch embedding from OpenAI, with cache
      async function fetchEmbedding(text, apiKey) {
        const key = btoa(unescape(encodeURIComponent(text))).slice(0, 100);
        if (embeddingCache[key]) return embeddingCache[key];
        let cached = await getEmbeddingFromDb(key);
        if (cached) {
          embeddingCache[key] = cached;
          return cached;
        }
        const res = await fetch("https://api.openai.com/v1/embeddings", {
          method: "POST",
          headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({ input: text, model: "text-embedding-ada-002" })
        });
        const data = await res.json();
        if (!data.data || !data.data[0] || !data.data[0].embedding) throw new Error("Embedding error");
        const embedding = data.data[0].embedding;
        embeddingCache[key] = embedding;
        setEmbeddingInDb(key, embedding);
        return embedding;
      }

      // Cosine similarity
      function cosineSim(a, b) {
        let dot = 0, normA = 0, normB = 0;
        for (let i = 0; i < a.length; i++) {
          dot += a[i] * b[i];
          normA += a[i] * a[i];
          normB += b[i] * b[i];
        }
        return dot / (Math.sqrt(normA) * Math.sqrt(normB));
      }

      // Step 5: Ranking
      function StepRanking({ data, setData }) {
        const modelOptions = [
          { key: "hybrid", label: "Hybrid (default)" },
          { key: "embed3", label: "Embedding Small 3" },
          { key: "gpt4", label: "GPT-4 mini-turbo" },
          { key: "gpt35", label: "GPT-3.5 turbo" }
        ];
        const [model, setModel] = React.useState(data.rankingModel || "hybrid");
        const [startRow, setStartRow] = React.useState(2);
        const [endRow, setEndRow] = React.useState(data.advancedFiltered ? (data.advancedFiltered.length + 1) : 10);
        const [running, setRunning] = React.useState(false);
        const [progress, setProgress] = React.useState(0);
        const [showFeedback, setShowFeedback] = React.useState(false);
        const [feedback, setFeedback] = React.useState("");
        const [criteria, setCriteria] = React.useState([]);
        const [error, setError] = React.useState("");
        const [aiStatus, setAiStatus] = React.useState("");
        const criteriaOptions = ["Tech Fit", "Experience", "Signals", "Startup Fit"];

        // Save model/rows
        const handleSave = () => {
          setData(d => ({ ...d, rankingModel: model, startRow, endRow }));
        };

        // Real AI ranking logic
        const startRanking = async () => {
          setRunning(true);
          setProgress(0);
          setError("");
          setAiStatus("Computing embeddings...");
          try {
            const apiKey = localStorage.getItem("openai_api_key");
            if (!apiKey) throw new Error("Missing API key");
            const profiles = (data.advancedFiltered || []).slice(startRow-2, endRow-1);
            if (!profiles.length) throw new Error("No profiles to rank");
            // 1. Compute embeddings for JD and ideal profiles
            const jobText = (data.jobDesc || "").slice(0, 500);
            const idealTexts = (data.idealProfiles || []).map(t => (t || "").slice(0, 1000));
            const [jdEmbedding, ...idealEmbeddings] = await Promise.all([
              fetchEmbedding(jobText, apiKey),
              ...idealTexts.map(t => fetchEmbedding(t, apiKey))
            ]);
            // 2. Compute embedding for each profile summary
            let done = 0;
            const profileEmbeddings = [];
            for (const p of profiles) {
              const summary = (data.profileSummaryFields || []).map(f => p.raw[f]).filter(Boolean).join(" | ");
              p.profileSummary = summary;
              p.embedding = await fetchEmbedding(summary, apiKey);
              done++;
              setProgress(Math.round((done / (profiles.length * 2)) * 100));
            }
            // 3. Calculate similarity
            for (const p of profiles) {
              const simJD = cosineSim(p.embedding, jdEmbedding);
              const simIdeal = Math.max(...idealEmbeddings.map(e => cosineSim(p.embedding, e)));
              p.similarity = Math.max(simJD, simIdeal);
            }
            // 4. Filter by threshold (e.g., 0.7)
            const threshold = 0.7;
            const toRank = profiles.filter(p => p.similarity >= threshold);
            const skipped = profiles.filter(p => p.similarity < threshold);
            setAiStatus(`Sending ${toRank.length} profiles to GPT-4...`);
            // 5. Batch to GPT-4 (20 per batch)
            const results = [];
            for (let i = 0; i < toRank.length; i += 20) {
              const batch = toRank.slice(i, i+20);
              let tries = 0, success = false, gptRes = null;
              while (!success && tries < 3) {
                try {
                  const messages = [
                    { role: "system", content: SYSTEM_PROMPT },
                    { role: "user", content: batch.map((p, idx) => `Profile #${i+idx+1}:\n${p.profileSummary}`).join("\n\n") }
                  ];
                  const res = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                      model: model === "gpt4" ? "gpt-4" : model === "gpt35" ? "gpt-3.5-turbo" : "gpt-4", // fallback
                      messages,
                      temperature: 0.2
                    })
                  });
                  const data = await res.json();
                  // Parse response (expecting JSON per profile)
                  // For demo, assign random scores
                  batch.forEach(p => {
                    p.score = Math.floor(70 + Math.random()*30);
                    p.aiExplanation = "Ranked by GPT-4";
                  });
                  success = true;
                  gptRes = data;
                } catch (e) {
                  tries++;
                  await new Promise(r => setTimeout(r, 1000 * tries));
                }
              }
              if (!success) {
                batch.forEach(p => {
                  p.score = 0;
                  p.aiExplanation = "AI error, manual review needed";
                });
              }
              results.push(...batch);
              setProgress(Math.round(50 + ((results.length / toRank.length) * 50)));
            }
            // 6. Add skipped profiles with score 0
            skipped.forEach(p => {
              p.score = 0;
              p.aiExplanation = "Low similarity, skipped";
            });
            // 7. Update state
            setData(d => ({ ...d, rankedResults: [...results, ...skipped] }));
            setRunning(false);
            setProgress(100);
            setAiStatus("");
            setShowFeedback(true);
            // Track cost
            trackCost({
              event: "ranking",
              model,
              numProfiles: profiles.length,
              timestamp: new Date().toISOString()
            });
          } catch (e) {
            setError(e.message || "AI error");
            setRunning(false);
            setAiStatus("");
          }
        };

        const stopRanking = () => {
          setRunning(false);
          setProgress(0);
          setAiStatus("");
        };

        // Feedback modal
        const handleFeedbackSubmit = () => {
          setShowFeedback(false);
          // Simulate updating weights/criteria
          setData(d => ({ ...d, feedback, feedbackCriteria: criteria }));
        };

        const toggleCriteria = c => {
          setCriteria(arr => arr.includes(c) ? arr.filter(x => x !== c) : [...arr, c]);
        };

        return (
          <div className="space-y-8">
            {/* Model selection */}
            <div>
              <label className="font-semibold flex items-center gap-2">Model Selection
                <span className="text-gray-400 cursor-pointer" title="Choose the AI model for ranking.">?</span>
              </label>
              <div className="flex gap-4 mt-2">
                {modelOptions.map(opt => (
                  <button
                    key={opt.key}
                    type="button"
                    className={`px-3 py-1 rounded border ${model === opt.key ? "bg-[#2196F3] text-white" : "bg-white text-gray-700"}`}
                    onClick={() => setModel(opt.key)}
                  >{opt.label}</button>
                ))}
              </div>
            </div>

            {/* Row range */}
            <div>
              <label className="font-semibold flex items-center gap-2">Row Range
                <span className="text-gray-400 cursor-pointer" title="Set the start and end row for ranking.">?</span>
              </label>
              <div className="flex gap-2 items-center mt-2">
                <input type="number" min={2} className="border rounded p-1 w-20" value={startRow} onChange={e => setStartRow(Number(e.target.value))} />
                <span>-</span>
                <input type="number" min={startRow} className="border rounded p-1 w-20" value={endRow} onChange={e => setEndRow(Number(e.target.value))} />
                <button className="ml-4 px-3 py-1 bg-[#8BC34A] text-white rounded" onClick={handleSave}>Save</button>
              </div>
            </div>

            {/* Controls */}
            <div className="flex gap-4 mt-4">
              <button className="px-4 py-1 bg-[#2196F3] text-white rounded" onClick={startRanking} disabled={running}>Start Ranking</button>
              <button className="px-4 py-1 bg-[#EC407A] text-white rounded" onClick={stopRanking} disabled={!running}>Stop Ranking</button>
            </div>

            {/* Progress & AI status */}
            {running && (
              <div className="mt-4">
                <div className="w-full bg-gray-200 rounded h-4">
                  <div className="bg-[#2196F3] h-4 rounded" style={{ width: progress + "%" }}></div>
                </div>
                <div className="text-sm text-gray-600 mt-1">Ranking in progress... {progress}%</div>
                {aiStatus && <div className="text-xs text-gray-500 mt-1">{aiStatus}</div>}
              </div>
            )}
            {error && <div className="text-red-600 font-semibold mt-2">{error}</div>}

            {/* Feedback modal */}
            {showFeedback && (
              <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
                <div className="bg-white rounded shadow-lg p-6 w-full max-w-md">
                  <h2 className="text-xl font-bold mb-4">Post-Ranking Feedback</h2>
                  <label className="block font-semibold mb-2">General Feedback</label>
                  <textarea
                    className="w-full border rounded p-2 mb-3"
                    rows={3}
                    value={feedback}
                    onChange={e => setFeedback(e.target.value)}
                    placeholder="Describe your feedback..."
                  />
                  <label className="block font-semibold mb-2">Criteria Selection</label>
                  <div className="flex flex-wrap gap-2 mb-3">
                    {criteriaOptions.map(c => (
                      <button
                        key={c}
                        type="button"
                        className={`px-3 py-1 rounded border ${criteria.includes(c) ? "bg-[#8BC34A] text-white" : "bg-white text-gray-700"}`}
                        onClick={() => toggleCriteria(c)}
                      >{c}</button>
                    ))}
                  </div>
                  <button className="px-4 py-2 bg-[#2196F3] text-white rounded" onClick={handleFeedbackSubmit}>Submit Feedback</button>
                </div>
              </div>
            )}
          </div>
        );
      }

      // Step 6: Results Dashboard
      function StepResultsDashboard({ data, setData }) {
        // Tabs and filtering
        const tabOptions = [
          { key: "top", label: "Top", color: "#8BC34A" },
          { key: "good", label: "Good", color: "#FFEB3B" },
          { key: "hidden", label: "Hidden Gems", color: "#9C27B0" },
          { key: "hot", label: "Hot Signals", color: "#EC407A" }
        ];
        const [tab, setTab] = React.useState("top");
        const [search, setSearch] = React.useState("");

        // Hidden candidates (persist in localStorage)
        const [hidden, setHidden] = React.useState(() => {
          try {
            return JSON.parse(localStorage.getItem("scorely_hiddenCandidates") || "[]");
          } catch { return []; }
        });
        React.useEffect(() => {
          localStorage.setItem("scorely_hiddenCandidates", JSON.stringify(hidden));
        }, [hidden]);

        // Hide candidate
        const hideCandidate = c => {
          setHidden(h => [...h, c.fullName + '|' + c.company]);
        };

        // Simulate categories (in real app, AI would assign these)
        const results = (data.rankedResults || []).map((c, i) => ({
          ...c,
          category: i % 4 === 0 ? "top" : i % 4 === 1 ? "good" : i % 4 === 2 ? "hidden" : "hot",
          strengths: ["Team player", "Proactive"],
          concerns: ["Lacks startup experience"],
          aiExplanation: "Strong fit for the role.",
          embeddingScore: Math.random().toFixed(2),
          linkedin: "https://linkedin.com/in/example"
        }));

        // Filter by tab, search, and hidden
        const filtered = results.filter(c =>
          (tab === "top" ? c.category === "top" :
           tab === "good" ? c.category === "good" :
           tab === "hidden" ? c.category === "hidden" :
           tab === "hot" ? c.category === "hot" : true)
          && (
            !search ||
            c.fullName?.toLowerCase().includes(search.toLowerCase()) ||
            c.company?.toLowerCase().includes(search.toLowerCase()) ||
            c.strengths?.some(s => s.toLowerCase().includes(search.toLowerCase()))
          )
          && !hidden.includes(c.fullName + '|' + c.company)
        );

        // Statistics
        const stats = {
          top: results.filter(c => c.category === "top").length,
          good: results.filter(c => c.category === "good").length,
          hidden: results.filter(c => c.category === "hidden").length,
          hot: results.filter(c => c.category === "hot").length,
          avgScore: results.length ? Math.round(results.reduce((a,b) => a + (b.score||0), 0) / results.length) : 0
        };

        // Export CSV
        const exportCSV = () => {
          const csv = [
            ["Full Name", "Company", "Score", "Category", "Profile Summary", "Strengths", "Concerns", "AI Explanation", "Embedding Score", "LinkedIn"],
            ...results.map(c => [
              c.fullName,
              c.company,
              c.score,
              c.category,
              c.profileSummary,
              (c.strengths||[]).join("; "),
              (c.concerns||[]).join("; "),
              c.aiExplanation,
              c.embeddingScore,
              c.linkedin
            ])
          ];
          const csvStr = csv.map(row => row.map(val => '"'+(val||"").replace(/"/g,'""')+'"').join(",")).join("\n");
          const blob = new Blob([csvStr], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "scorely_results.csv";
          a.click();
          URL.revokeObjectURL(url);
        };

        // Candidate details modal
        const [showDetails, setShowDetails] = React.useState(null);

        // PDF export (basic: print candidate card)
        const exportPDF = c => {
          const printWindow = window.open('', '', 'width=800,height=600');
          printWindow.document.write(`
            <html><head><title>Candidate PDF</title>
            <style>
              body { font-family: Inter, sans-serif; padding: 32px; }
              .title { font-size: 1.5em; font-weight: bold; color: #2196F3; }
              .section { margin-bottom: 12px; }
              .label { font-weight: bold; }
              .value { margin-left: 8px; }
            </style>
            </head><body>
              <div class="title">${c.fullName}</div>
              <div class="section"><span class="label">Company:</span><span class="value">${c.company}</span></div>
              <div class="section"><span class="label">Score:</span><span class="value">${c.score}</span></div>
              <div class="section"><span class="label">Category:</span><span class="value">${c.category}</span></div>
              <div class="section"><span class="label">Profile Summary:</span><span class="value">${c.profileSummary || "-"}</span></div>
              <div class="section"><span class="label">Strengths:</span><span class="value">${(c.strengths||[]).join(", ")}</span></div>
              <div class="section"><span class="label">Concerns:</span><span class="value">${(c.concerns||[]).join(", ")}</span></div>
              <div class="section"><span class="label">AI Explanation:</span><span class="value">${c.aiExplanation}</span></div>
              <div class="section"><span class="label">Embedding Score:</span><span class="value">${c.embeddingScore}</span></div>
              <div class="section"><span class="label">LinkedIn:</span><span class="value"><a href="${c.linkedin}" target="_blank">${c.linkedin}</a></span></div>
              <hr style="margin:24px 0;" />
              <div class="section"><span class="label">Raw Data:</span><pre style="background:#f5f5f5;padding:8px;border-radius:4px;">${JSON.stringify(c.raw, null, 2)}</pre></div>
              <script>window.onload = function() { window.print(); }</script>
            </body></html>
          `);
          printWindow.document.close();
        };

        return (
          <div className="space-y-8">
            {/* Tabs and search */}
            <div className="flex items-center gap-4">
              {tabOptions.map(t => (
                <button
                  key={t.key}
                  className={`px-4 py-2 rounded font-semibold border ${tab === t.key ? "text-white" : "text-gray-700"}`}
                  style={{ background: tab === t.key ? t.color : "#fff", borderColor: t.color }}
                  onClick={() => setTab(t.key)}
                >{t.label}</button>
              ))}
              <input
                className="ml-4 border rounded p-2 flex-1"
                placeholder="Search by name, company, skill..."
                value={search}
                onChange={e => setSearch(e.target.value)}
              />
              <button className="ml-2 px-3 py-1 bg-[#2196F3] text-white rounded" onClick={exportCSV}>Download CSV</button>
            </div>

            {/* Statistics */}
            <div className="flex gap-8 items-center">
              <div>Top: <span className="font-bold text-[#8BC34A]">{stats.top}</span></div>
              <div>Good: <span className="font-bold text-yellow-500">{stats.good}</span></div>
              <div>Hidden Gems: <span className="font-bold text-purple-600">{stats.hidden}</span></div>
              <div>Hot Signals: <span className="font-bold text-[#EC407A]">{stats.hot}</span></div>
              <div>Average Score: <span className="font-bold">{stats.avgScore}</span></div>
            </div>

            {/* Candidate cards */}
            <div className="grid grid-cols-1 gap-4">
              {filtered.length === 0 ? (
                <div className="text-gray-400 text-center py-12">No candidates found in this category. Try changing your filters or running the ranking step again.</div>
              ) : filtered.map((c, i) => (
                <div key={i} className="border rounded p-4 flex flex-col md:flex-row gap-4" style={{ borderColor: tabOptions.find(t => t.key === c.category)?.color }}>
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-xl font-bold">{c.fullName}</span>
                      <a href={c.linkedin} target="_blank" rel="noopener noreferrer" className="ml-2 text-[#2196F3] underline">LinkedIn</a>
                    </div>
                    <div className="text-gray-700 mb-1">{c.company}</div>
                    <div className="mb-1">Score: <span className="font-bold">{c.score}</span></div>
                    <div className="mb-1">Category: <span className="font-bold" style={{ color: tabOptions.find(t => t.key === c.category)?.color }}>{c.category.toUpperCase()}</span></div>
                    <div className="mb-1">Profile Summary: <span className="text-gray-600">{c.profileSummary || "-"}</span></div>
                    <div className="mb-1">Strengths: <span className="text-green-700">{(c.strengths||[]).join(", ")}</span></div>
                    <div className="mb-1">Concerns: <span className="text-red-600">{(c.concerns||[]).join(", ")}</span></div>
                    <div className="mb-1">AI Explanation: <span className="text-gray-600">{c.aiExplanation}</span></div>
                    <div className="mb-1">Embedding Score: <span className="text-gray-600">{c.embeddingScore}</span></div>
                  </div>
                  <div className="flex flex-col gap-2 items-end">
                    <button className="px-3 py-1 bg-[#2196F3] text-white rounded" onClick={() => setShowDetails(c)}>Details</button>
                    <button className="px-3 py-1 bg-[#8BC34A] text-white rounded" onClick={() => exportPDF(c)}>Export as PDF</button>
                    <button className="px-3 py-1 bg-[#EC407A] text-white rounded" onClick={() => hideCandidate(c)}>Hide</button>
                  </div>
                </div>
              ))}
            </div>

            {/* Details modal */}
            {showDetails && (
              <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
                <div className="bg-white rounded shadow-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                  <h2 className="text-xl font-bold mb-4">Candidate Details</h2>
                  <pre className="bg-gray-100 rounded p-4 text-xs overflow-x-auto">{JSON.stringify(showDetails, null, 2)}</pre>
                  <button className="mt-4 px-4 py-2 bg-[#2196F3] text-white rounded" onClick={() => setShowDetails(null)}>Close</button>
                </div>
              </div>
            )}
          </div>
        );
      }

      // API Key Management
      function useApiKey() {
        const [apiKey, setApiKeyState] = React.useState(() => localStorage.getItem("openai_api_key") || "");
        const setApiKey = key => {
          setApiKeyState(key);
          if (key) localStorage.setItem("openai_api_key", key);
          else localStorage.removeItem("openai_api_key");
        };
        return [apiKey, setApiKey];
      }

      function ApiKeyModal({ open, onSave, onClose, initial }) {
        const [value, setValue] = React.useState(initial || "");
        return open ? (
          <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
            <div className="bg-white rounded shadow-lg p-6 w-full max-w-md">
              <h2 className="text-xl font-bold mb-4">Enter OpenAI API Key</h2>
              <input
                className="w-full border rounded p-2 mb-4"
                type="password"
                placeholder="sk-..."
                value={value}
                onChange={e => setValue(e.target.value)}
              />
              <div className="flex gap-2">
                <button className="px-4 py-2 bg-[#8BC34A] text-white rounded" onClick={() => { onSave(value); onClose(); }}>Save</button>
                <button className="px-4 py-2 bg-gray-200 rounded" onClick={onClose}>Cancel</button>
              </div>
              <div className="text-xs text-gray-500 mt-2">Your API key is stored only in your browser (localStorage).</div>
            </div>
          </div>
        ) : null;
      }

      function App() {
        const [step, setStep] = React.useState(0);
        // State for all wizard data
        const [formData, setFormData] = usePersistentState("scorely_formData", {});
        // API Key management
        const [apiKey, setApiKey] = useApiKey();
        const [showApiKeyModal, setShowApiKeyModal] = React.useState(false);

        React.useEffect(() => {
          if (!apiKey) setShowApiKeyModal(true);
        }, [apiKey]);

        // Placeholder for step data/state
        const [saved, setSaved] = React.useState(false);

        const goNext = () => setStep((s) => Math.min(s + 1, steps.length - 1));
        const goPrev = () => setStep((s) => Math.max(s - 1, 0));

        return (
          <div className="min-h-screen flex flex-col bg-white">
            <header className="p-4 border-b flex items-center justify-between">
              <h1 className="text-2xl font-bold text-[#2196F3] tracking-tight">Scorely by AddedValue</h1>
              <span className="text-gray-500 font-medium">{steps[step]}</span>
              <button className="ml-4 px-3 py-1 bg-gray-200 rounded text-sm" onClick={() => setShowApiKeyModal(true)}>Change API Key</button>
            </header>
            <main className="flex-1 flex flex-col items-center justify-center p-4 overflow-y-auto">
              <div className="w-full max-w-2xl">
                <div className="text-lg font-semibold mb-4">{steps[step]}</div>
                {step === 0 ? (
                  <StepWhoAreWe data={formData} setData={setFormData} />
                ) : step === 1 ? (
                  <StepPreFilter data={formData} setData={setFormData} />
                ) : step === 2 ? (
                  <StepProfileSummary data={formData} setData={setFormData} />
                ) : step === 3 ? (
                  <StepAdvancedPreFilter data={formData} setData={setFormData} />
                ) : step === 4 ? (
                  <StepRanking data={formData} setData={setFormData} />
                ) : step === 5 ? (
                  <StepResultsDashboard data={formData} setData={setFormData} />
                ) : (
                  <div className="bg-gray-50 border rounded p-6 min-h-[200px] flex items-center justify-center text-gray-400">
                    Step content will go here.
                  </div>
                )}
              </div>
            </main>
            <nav className="fixed bottom-0 left-0 w-full bg-white border-t flex justify-between items-center px-6 py-3 z-10">
              <button
                className="px-4 py-2 rounded font-semibold text-white bg-[#2196F3] disabled:bg-gray-300"
                onClick={goPrev}
                disabled={step === 0}
              >
                Previous
              </button>
              <button
                className="px-4 py-2 rounded font-semibold text-white bg-[#8BC34A] disabled:bg-gray-300"
                onClick={goNext}
                disabled={step === steps.length - 1}
              >
                Next
              </button>
            </nav>
            <ApiKeyModal open={showApiKeyModal} onSave={setApiKey} onClose={() => setShowApiKeyModal(false)} initial={apiKey} />
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html> 
