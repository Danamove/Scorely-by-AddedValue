<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scorely - AI-Powered LinkedIn Profile Ranking</title>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        
        .candidate-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        
        .candidate-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .score-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .score-top { background-color: #dcfce7; color: #166534; }
        .score-good { background-color: #fef3c7; color: #92400e; }
        .score-hidden { background-color: #f3e8ff; color: #7c3aed; }
        .score-hot { background-color: #fee2e2; color: #dc2626; }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">Scorely</h1>
                    <span class="ml-2 text-sm text-gray-500">AI-Powered Profile Ranking</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="nav-setup" class="nav-tab px-3 py-2 rounded-md text-sm font-medium">Setup</button>
                    <button id="nav-ranking" class="nav-tab px-3 py-2 rounded-md text-sm font-medium">Ranking</button>
                    <button id="nav-results" class="nav-tab px-3 py-2 rounded-md text-sm font-medium">Results</button>
                    <button id="reset-session" class="px-3 py-2 rounded-md text-sm font-medium text-red-600 hover:bg-red-50">Reset Session</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main App Container -->
    <div id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <!-- Navigation Footer -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-3">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <button id="prevBtn" class="bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Previous
            </button>
            <div class="text-sm text-gray-600">
                <span id="currentStep">Setup</span> / <span id="totalSteps">3</span>
            </div>
            <button id="nextBtn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Next
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="columnMappingModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-lg font-semibold mb-4">Map CSV Columns</h2>
            <div id="columnMappingForm"></div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="detailModalContent"></div>
        </div>
    </div>

    <script>
        // Global State Management
        const state = {
            currentView: 'setup',
            apiKey: localStorage.getItem('scorely_api_key') || '',
            embeddingModel: localStorage.getItem('scorely_embedding_model') || 'text-embedding-3-small',
            gptModel: localStorage.getItem('scorely_gpt_model') || 'gpt-3.5-turbo',
            hybridMode: localStorage.getItem('scorely_hybrid_mode') !== 'false', // Default to true
            profiles: [],
            columnMapping: {},
            filters: {
                blacklist: JSON.parse(localStorage.getItem('scorely_blacklist') || '[]'),
                pastCandidates: JSON.parse(localStorage.getItem('scorely_past_candidates') || '[]'),
                noGoCompanies: JSON.parse(localStorage.getItem('scorely_nogo_companies') || '[]'),
                minYears: 0,
                education: [],
                essentialSkills: '',
                suitableRoles: [],
                redFlags: {
                    instability: false,
                    stagnation: false,
                    enterpriseOnly: false,
                    freelancer: false
                }
            },
            jobConfig: {
                description: '',
                idealProfiles: [],
                hotSignals: [],
                companySize: [],
                industry: [],
                experienceRange: { min: 0, max: 50 },
                excellenceBadges: [],
                customTraits: [],
                weights: {
                    techFit: 25,
                    experience: 25,
                    signals: 25,
                    startupFit: 25
                }
            },
            results: {
                top: [],
                good: [],
                hidden: [],
                hotSignals: []
            },
            stats: {
                uploaded: 0,
                filteredOut: 0,
                skippedEmbedding: 0,
                toBeSentToGPT: 0
            }
        };

        // Constants
        const ROLE_SYNONYMS = {
            'software engineer': ['developer', 'programmer', 'coder', 'engineer'],
            'product manager': ['pm', 'product owner', 'product lead'],
            'data scientist': ['ml engineer', 'ai engineer', 'analyst'],
            'designer': ['ux designer', 'ui designer', 'product designer']
        };

        const EMBEDDING_THRESHOLD = 0.7;

        // Predefined lists
        const PREDEFINED_NO_GO_COMPANIES = [
            'Isracard', 'Matrix', 'Harel Insurance & Finance', 'Ness Technologies', 
            'Bank Leumi', 'GAV Systems', 'Amdocs', 'Log-On Software', 'Sapiens', 
            'Aman Group', 'NICE', 'Maccabi Healthcare Services', 'Zap Group', 
            'Clalit Health Services', 'Bank Hapoalim', 'Israel Tax Authority', 
            'Discount Bank', 'Infanity Labs', 'Experis Israel', 'Sapiens International', 
            'Magic Software Enterprises', 'Ethernity Networks', 'Elad Software Systems', 
            'Mizrahi-Tefahot Bank', 'Migdal Insurance', 'Menora Mivtachim', 
            'Clal Insurance', 'Taldor', 'Bynet Data Communications', 'Hachshara Insurance', 
            'Psagot Investment House', 'Max (It Finance)'
        ];

        const PREDEFINED_UNIVERSITIES = [
            'Hebrew University of Jerusalem', 'Technion – Israel Institute of Technology', 
            'Tel Aviv University', 'Bar-Ilan University', 'Ben-Gurion University of the Negev', 
            'Weizmann Institute of Science', 'Reichman University', 'University of Haifa', 
            'The Academic College of Tel‑Aviv‑Yaffo'
        ];

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Set up navigation
            document.getElementById('nav-setup').addEventListener('click', () => switchView('setup'));
            document.getElementById('nav-ranking').addEventListener('click', () => switchView('ranking'));
            document.getElementById('nav-results').addEventListener('click', () => switchView('results'));
            document.getElementById('reset-session').addEventListener('click', resetSession);

            // Set up navigation footer buttons
            document.getElementById('prevBtn').addEventListener('click', navigatePrevious);
            document.getElementById('nextBtn').addEventListener('click', navigateNext);

            // Set up modal close handlers
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });

            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });

            // Load initial view
            switchView('setup');
        }

        function switchView(view) {
            state.currentView = view;
            
            // Update navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('tab-active');
            });
            document.getElementById(`nav-${view}`).classList.add('tab-active');

            // Render view
            switch(view) {
                case 'setup':
                    renderSetupView();
                    break;
                case 'ranking':
                    renderRankingView();
                    break;
                case 'results':
                    renderResultsView();
                    break;
            }
            
            // Update navigation footer
            updateNavigation();
        }

        function renderSetupView() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="space-y-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">1. Upload Profile Data</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Upload CSV or Excel file
                                </label>
                                <input type="file" id="fileInput" accept=".csv,.xlsx" 
                                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                            <div id="uploadStatus" class="hidden">
                                <p class="text-sm text-gray-600">Processing file...</p>
                            </div>
                        </div>
                    </div>

                    <div id="columnMappingSection" class="hidden bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">2. Map Columns</h2>
                        <button id="mapColumnsBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Map CSV Columns
                        </button>
                    </div>

                    <div id="preFilterSection" class="hidden bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">3. Pre-Filter Configuration (Round 1)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <h3 class="text-lg font-medium mb-2">Blacklist Companies</h3>
                                <textarea id="blacklist" rows="4" class="w-full border border-gray-300 rounded-md p-2" 
                                          placeholder="Enter company names, one per line"></textarea>
                                <div class="mt-2 flex space-x-2">
                                    <button id="saveBlacklist" class="bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 text-sm">
                                        Save Blacklist
                                    </button>
                                    <button id="clearBlacklist" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 text-sm">
                                        Clear
                                    </button>
                                </div>
                                <div id="blacklistSaveStatus" class="mt-1 text-xs text-gray-600 hidden">
                                    <span class="text-green-600">✓ Blacklist saved!</span>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-2">Past Candidates</h3>
                                <textarea id="pastCandidates" rows="4" class="w-full border border-gray-300 rounded-md p-2" 
                                          placeholder="Enter names or LinkedIn URLs"></textarea>
                                <div class="mt-2 flex space-x-2">
                                    <button id="savePastCandidates" class="bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 text-sm">
                                        Save Past Candidates
                                    </button>
                                    <button id="clearPastCandidates" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 text-sm">
                                        Clear
                                    </button>
                                </div>
                                <div id="pastCandidatesSaveStatus" class="mt-1 text-xs text-gray-600 hidden">
                                    <span class="text-green-600">✓ Past candidates saved!</span>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-2">No-Go Companies</h3>
                                <div class="mb-3 p-3 bg-gray-50 rounded-md">
                                    <p class="text-sm text-gray-600 mb-2">Predefined NO-GO companies:</p>
                                    <div class="text-xs text-gray-700 space-y-1 max-h-32 overflow-y-auto">
                                        ${PREDEFINED_NO_GO_COMPANIES.join(', ')}
                                    </div>
                                </div>
                                <textarea id="noGoCompanies" rows="4" class="w-full border border-gray-300 rounded-md p-2" 
                                          placeholder="Enter additional company names (one per line)"></textarea>
                                <div class="mt-2 flex space-x-2">
                                    <button id="addPredefinedNoGo" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 text-sm">
                                        Add Predefined NO-GO List
                                    </button>
                                    <button id="saveNoGoCompanies" class="bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 text-sm">
                                        Save No-Go
                                    </button>
                                    <button id="clearNoGoCompanies" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 text-sm">
                                        Clear
                                    </button>
                                </div>
                                <div id="noGoCompaniesSaveStatus" class="mt-1 text-xs text-gray-600 hidden">
                                    <span class="text-green-600">✓ No-Go companies saved!</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-4">
                            <button id="saveFiltersBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                Save Filters
                            </button>
                            <button id="clearFiltersBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                Clear All
                            </button>
                            <button id="runFilteringRound1Btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                Run Round 1 Filtering
                            </button>
                        </div>
                        <div id="filtersSaveStatus" class="mt-2 text-sm text-gray-600 hidden">
                            <span class="text-green-600">✓ Filters saved successfully!</span>
                        </div>
                    </div>

                    <div id="round1Results" class="hidden bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Round 1 Filter Results</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="round1Uploaded">0</div>
                                <div class="text-sm text-gray-600">Uploaded</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-600" id="round1FilteredOut">0</div>
                                <div class="text-sm text-gray-600">Filtered Out</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="round1Remaining">0</div>
                                <div class="text-sm text-gray-600">Remaining</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-600" id="round1Duplicates">0</div>
                                <div class="text-sm text-gray-600">Duplicates Removed</div>
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <button id="proceedToRound2Btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                Proceed to Round 2
                            </button>
                            <button id="clearDashboardBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                Clear Dashboard
                            </button>
                        </div>
                    </div>

                    <div id="profileSummarySection" class="hidden bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">4. Profile Summary Configuration</h2>
                        <p class="text-gray-600 mb-4">Select which columns to include in the profile summary for AI analysis:</p>
                        <div id="columnSelection" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 rounded-md p-4">
                            <!-- Column checkboxes will be populated here -->
                        </div>
                        <div class="mt-4 flex space-x-4">
                            <button id="selectAllColumns" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                                Select All
                            </button>
                            <button id="clearAllColumns" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                                Clear All
                            </button>
                            <button id="saveColumnSelection" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                Save Selection
                            </button>
                            <button id="clearColumnSelection" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                Clear Selection
                            </button>
                        </div>
                        <div id="columnSelectionSaveStatus" class="mt-2 text-sm text-gray-600 hidden">
                            <span class="text-green-600">✓ Column selection saved successfully!</span>
                        </div>
                    </div>

                    <div id="advancedFilterSection" class="hidden bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">5. Advanced Pre-Filter Criteria (Round 2)</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium mb-3">Basic Thresholds</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Years of Experience</label>
                                        <input type="number" id="minYears" min="0" max="50" class="w-full border border-gray-300 rounded-md p-2" 
                                               placeholder="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Education (Universities)</label>
                                        <div class="mb-2 p-2 bg-gray-50 rounded-md">
                                            <p class="text-xs text-gray-600 mb-1">Predefined Israeli universities:</p>
                                            <div class="text-xs text-gray-700 space-y-1 max-h-20 overflow-y-auto">
                                                ${PREDEFINED_UNIVERSITIES.join(', ')}
                                            </div>
                                        </div>
                                        <textarea id="education" rows="3" class="w-full border border-gray-300 rounded-md p-2" 
                                                  placeholder="Enter university names, one per line"></textarea>
                                        <button id="addPredefinedEducation" class="mt-2 bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 text-sm">
                                            Add Predefined Universities
                                        </button>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Essential Skills</label>
                                        <input type="text" id="essentialSkills" class="w-full border border-gray-300 rounded-md p-2" 
                                               placeholder="JavaScript, React, Python (comma-separated)">
                                        <div class="mt-1 flex space-x-2">
                                            <button id="saveEssentialSkills" class="bg-green-600 text-white px-2 py-1 rounded-md hover:bg-green-700 text-xs">
                                                Save Skills
                                            </button>
                                            <button id="clearEssentialSkills" class="bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700 text-xs">
                                                Clear
                                            </button>
                                        </div>
                                        <div id="essentialSkillsSaveStatus" class="mt-1 text-xs text-gray-600 hidden">
                                            <span class="text-green-600">✓ Skills saved!</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Suitable Role</label>
                                        <input type="text" id="suitableRoles" class="w-full border border-gray-300 rounded-md p-2" 
                                               placeholder="Software Engineer, Developer, Programmer">
                                    </div>
                                </div>
                                <div class="mt-3 flex space-x-2">
                                    <button id="saveBasicThresholds" class="bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 text-sm">
                                        Save Thresholds
                                    </button>
                                    <button id="clearBasicThresholds" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 text-sm">
                                        Clear All
                                    </button>
                                </div>
                                <div id="basicThresholdsSaveStatus" class="mt-1 text-xs text-gray-600 hidden">
                                    <span class="text-green-600">✓ Basic thresholds saved!</span>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-lg font-medium mb-3">Red-Flag Patterns</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="instability" class="mr-2">
                                        <label for="instability" class="text-sm text-gray-700">Instability (<1 year in role or job hops in last 6 years)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="stagnation" class="mr-2">
                                        <label for="stagnation" class="text-sm text-gray-700">Stagnation (>7 years at same company)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="enterpriseOnly" class="mr-2">
                                        <label for="enterpriseOnly" class="text-sm text-gray-700">Enterprise-only background</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="freelancer" class="mr-2">
                                        <label for="freelancer" class="text-sm text-gray-700">Freelancer/Independent</label>
                                    </div>
                                </div>
                                <div class="mt-3 flex space-x-2">
                                    <button id="saveRedFlags" class="bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 text-sm">
                                        Save Red Flags
                                    </button>
                                    <button id="clearRedFlags" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 text-sm">
                                        Clear All
                                    </button>
                                </div>
                                <div id="redFlagsSaveStatus" class="mt-1 text-xs text-gray-600 hidden">
                                    <span class="text-green-600">✓ Red flags saved!</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                            <h4 class="font-medium text-blue-900 mb-2">Benefits of Advanced Filtering:</h4>
                            <ul class="text-sm text-blue-800 space-y-1">
                                <li>• <strong>Cost Savings:</strong> Reduce AI calls by 60-80%</li>
                                <li>• <strong>Speed:</strong> Process 1000+ profiles in minutes</li>
                                <li>• <strong>Accuracy:</strong> Focus on relevant candidates only</li>
                            </ul>
                        </div>

                        <div class="mt-6 flex space-x-4">
                            <button id="runFilteringRound2Btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                Run Round 2 Filtering
                            </button>
                            <button id="saveAdvancedFiltersBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                Save Advanced Filters
                            </button>
                        </div>
                    </div>

                    <div id="round2Results" class="hidden bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Round 2 Filter Results</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="round2Screening">0</div>
                                <div class="text-sm text-gray-600">Screening</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-600" id="round2SkippedEmbedding">0</div>
                                <div class="text-sm text-gray-600">Skipped by Embedding</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="round2ToRank">0</div>
                                <div class="text-sm text-gray-600">To Rank</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-600" id="round2FilteredOut">0</div>
                                <div class="text-sm text-gray-600">Filtered Out</div>
                            </div>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg">
                            <h4 class="font-medium text-green-900 mb-2">Ready for Ranking!</h4>
                            <p class="text-sm text-green-800">Your profiles have been filtered and are ready for AI-powered ranking.</p>
                        </div>
                    </div>
                </div>
            `;

            // Set up event listeners
            setupFileUpload();
            setupFilterHandlers();
        }

        function setupFilterHandlers() {
            // Load existing filter data
            document.getElementById('blacklist').value = state.filters.blacklist.join('\n');
            document.getElementById('pastCandidates').value = state.filters.pastCandidates.join('\n');
            document.getElementById('noGoCompanies').value = state.filters.noGoCompanies.join('\n');

            // Set up save and run buttons
            document.getElementById('saveFiltersBtn').addEventListener('click', saveFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('runFilteringRound1Btn').addEventListener('click', runFilteringRound1);
            document.getElementById('mapColumnsBtn').addEventListener('click', showColumnMappingModal);
            
            // Individual save buttons for Setup categories
            document.getElementById('saveBlacklist').addEventListener('click', saveBlacklist);
            document.getElementById('clearBlacklist').addEventListener('click', clearBlacklist);
            document.getElementById('savePastCandidates').addEventListener('click', savePastCandidates);
            document.getElementById('clearPastCandidates').addEventListener('click', clearPastCandidates);
            document.getElementById('saveNoGoCompanies').addEventListener('click', saveNoGoCompanies);
            document.getElementById('clearNoGoCompanies').addEventListener('click', clearNoGoCompanies);
            
            // Individual save buttons for Advanced Filters
            document.getElementById('saveBasicThresholds').addEventListener('click', saveBasicThresholds);
            document.getElementById('clearBasicThresholds').addEventListener('click', clearBasicThresholds);
            document.getElementById('saveRedFlags').addEventListener('click', saveRedFlags);
            document.getElementById('clearRedFlags').addEventListener('click', clearRedFlags);
            
            // Individual save buttons for Essential Skills and Ideal Profiles
            document.getElementById('saveEssentialSkills').addEventListener('click', saveEssentialSkills);
            document.getElementById('clearEssentialSkills').addEventListener('click', clearEssentialSkills);
            document.getElementById('saveIdealProfiles').addEventListener('click', saveIdealProfiles);
            document.getElementById('clearIdealProfiles').addEventListener('click', clearIdealProfiles);
            
            // Set up predefined lists buttons
            document.getElementById('addPredefinedNoGo').addEventListener('click', addPredefinedNoGo);
            document.getElementById('addPredefinedEducation').addEventListener('click', addPredefinedEducation);
            
            // Set up Round 1 results handlers
            document.getElementById('proceedToRound2Btn').addEventListener('click', proceedToRound2);
            document.getElementById('clearDashboardBtn').addEventListener('click', clearDashboard);
            
            // Set up column selection handlers
            document.getElementById('selectAllColumns').addEventListener('click', selectAllColumns);
            document.getElementById('clearAllColumns').addEventListener('click', clearAllColumns);
            document.getElementById('saveColumnSelection').addEventListener('click', saveColumnSelection);
            document.getElementById('clearColumnSelection').addEventListener('click', clearColumnSelection);
            
            // Set up Round 2 handlers
            document.getElementById('runFilteringRound2Btn').addEventListener('click', runFilteringRound2);
            document.getElementById('saveAdvancedFiltersBtn').addEventListener('click', saveAdvancedFilters);
            
            // Set up custom traits handlers
            document.getElementById('addCustomTrait').addEventListener('click', addCustomTrait);
            document.getElementById('saveCustomTraits').addEventListener('click', saveCustomTraits);
            document.getElementById('clearCustomTraits').addEventListener('click', clearCustomTraits);
            document.getElementById('newCustomTrait').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addCustomTrait();
            });
            
            // Set up navigation handlers
            document.getElementById('prevBtn').addEventListener('click', navigatePrevious);
            document.getElementById('nextBtn').addEventListener('click', navigateNext);
            
            // Set up advanced filter handlers
            setupAdvancedFilterHandlers();
            
            // Update navigation
            updateNavigation();
        }

        function saveFilters() {
            state.filters.blacklist = document.getElementById('blacklist').value.split('\n').filter(line => line.trim());
            state.filters.pastCandidates = document.getElementById('pastCandidates').value.split('\n').filter(line => line.trim());
            state.filters.noGoCompanies = document.getElementById('noGoCompanies').value.split('\n').filter(line => line.trim());
            
            localStorage.setItem('scorely_blacklist', JSON.stringify(state.filters.blacklist));
            localStorage.setItem('scorely_past_candidates', JSON.stringify(state.filters.pastCandidates));
            localStorage.setItem('scorely_nogo_companies', JSON.stringify(state.filters.noGoCompanies));
            
            showSaveStatus('filtersSaveStatus');
        }

        function clearFilters() {
            if (confirm('Are you sure you want to clear all filters?')) {
                document.getElementById('blacklist').value = '';
                document.getElementById('pastCandidates').value = '';
                document.getElementById('noGoCompanies').value = '';
                state.filters.blacklist = [];
                state.filters.pastCandidates = [];
                state.filters.noGoCompanies = [];
                
                localStorage.removeItem('scorely_blacklist');
                localStorage.removeItem('scorely_past_candidates');
                localStorage.removeItem('scorely_nogo_companies');
                
                alert('All filters cleared successfully!');
            }
        }

        function clearColumnSelection() {
            if (confirm('Are you sure you want to clear column selection?')) {
                document.querySelectorAll('#columnSelection input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                state.selectedColumns = [];
                localStorage.removeItem('scorely_selected_columns');
                alert('Column selection cleared!');
            }
        }

        function saveCustomTraits() {
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('customTraitsSaveStatus', 1500);
        }

        function clearCustomTraits() {
            if (confirm('Are you sure you want to clear all custom traits?')) {
                state.jobConfig.customTraits = [];
                localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
                renderRankingView(); // Refresh to show empty list
                showSaveStatus('customTraitsSaveStatus', 1500);
            }
        }

        function showSaveStatus(elementId, timeout = 3000) {
            const statusElement = document.getElementById(elementId);
            if (statusElement) {
                statusElement.classList.remove('hidden');
                setTimeout(() => {
                    statusElement.classList.add('hidden');
                }, timeout);
            }
        }

        function updateNavigation() {
            const currentStepElement = document.getElementById('currentStep');
            const totalStepsElement = document.getElementById('totalSteps');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            const steps = ['Setup', 'Ranking', 'Results'];
            const currentIndex = steps.indexOf(state.currentView);
            
            currentStepElement.textContent = steps[currentIndex];
            totalStepsElement.textContent = steps.length;
            
            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === steps.length - 1;
            
            // Update button text
            if (currentIndex === steps.length - 1) {
                nextBtn.textContent = 'Finish';
            } else {
                nextBtn.textContent = 'Next';
            }
        }

        function navigatePrevious() {
            const steps = ['setup', 'ranking', 'results'];
            const currentIndex = steps.indexOf(state.currentView);
            if (currentIndex > 0) {
                state.currentView = steps[currentIndex - 1];
                switchView(state.currentView);
                updateNavigation();
            }
        }

        function navigateNext() {
            const steps = ['setup', 'ranking', 'results'];
            const currentIndex = steps.indexOf(state.currentView);
            if (currentIndex < steps.length - 1) {
                state.currentView = steps[currentIndex + 1];
                switchView(state.currentView);
                updateNavigation();
            }
        }

        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileUpload);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.classList.remove('hidden');
            uploadStatus.innerHTML = '<p class="text-sm text-gray-600">Processing file...</p>';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let profiles = [];
                    const fileName = file.name.toLowerCase();
                    
                    if (fileName.endsWith('.csv')) {
                        profiles = parseCSV(e.target.result);
                    } else if (fileName.endsWith('.xlsx')) {
                        profiles = parseXLSX(e.target.result);
                    }

                    state.profiles = profiles;
                    state.stats.uploaded = profiles.length;
                    
                    uploadStatus.innerHTML = `<p class="text-sm text-green-600">Successfully loaded ${profiles.length} profiles</p>`;
                    document.getElementById('columnMappingSection').classList.remove('hidden');
                    
                } catch (error) {
                    uploadStatus.innerHTML = `<p class="text-sm text-red-600">Error processing file: ${error.message}</p>`;
                }
            };
            
            reader.readAsText(file);
        }

        function parseCSV(content) {
            const results = Papa.parse(content, {
                header: true,
                skipEmptyLines: true
            });
            
            if (results.errors.length > 0) {
                throw new Error('CSV parsing errors: ' + results.errors.map(e => e.message).join(', '));
            }
            
            return results.data;
        }

        function parseXLSX(content) {
            const workbook = XLSX.read(content, { type: 'binary' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            if (data.length < 2) {
                throw new Error('Excel file must have at least a header row and one data row');
            }
            
            const headers = data[0];
            const rows = data.slice(1);
            
            return rows.map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index] || '';
                });
                return obj;
            });
        }

        function addPredefinedNoGo() {
            const currentValue = document.getElementById('noGoCompanies').value;
            const currentCompanies = currentValue ? currentValue.split('\n').filter(line => line.trim()) : [];
            
            // Add predefined companies that aren't already in the list
            const newCompanies = PREDEFINED_NO_GO_COMPANIES.filter(company => 
                !currentCompanies.some(existing => 
                    existing.toLowerCase().includes(company.toLowerCase()) || 
                    company.toLowerCase().includes(existing.toLowerCase())
                )
            );
            
            const allCompanies = [...currentCompanies, ...newCompanies];
            document.getElementById('noGoCompanies').value = allCompanies.join('\n');
            
            alert(`Added ${newCompanies.length} predefined NO-GO companies to the list.`);
        }

        function addPredefinedEducation() {
            const currentValue = document.getElementById('education').value;
            const currentUniversities = currentValue ? currentValue.split('\n').filter(line => line.trim()) : [];
            
            // Add predefined universities that aren't already in the list
            const newUniversities = PREDEFINED_UNIVERSITIES.filter(university => 
                !currentUniversities.some(existing => 
                    existing.toLowerCase().includes(university.toLowerCase()) || 
                    university.toLowerCase().includes(existing.toLowerCase())
                )
            );
            
            const allUniversities = [...currentUniversities, ...newUniversities];
            document.getElementById('education').value = allUniversities.join('\n');
            
            alert(`Added ${newUniversities.length} predefined Israeli universities to the list.`);
        }

        function runFilteringRound1() {
            if (state.profiles.length === 0) {
                alert('Please upload a file first');
                return;
            }

            // Reset Round 1 stats
            const round1Stats = {
                uploaded: state.profiles.length,
                filteredOut: 0,
                remaining: 0,
                duplicates: 0
            };

            // Get all NO-GO companies (predefined + custom)
            const allNoGoCompanies = [...PREDEFINED_NO_GO_COMPANIES, ...state.filters.noGoCompanies];

            // Deduplicate profiles
            const uniqueProfiles = new Map();
            state.profiles.forEach(profile => {
                // Create a unique key from available fields
                const firstName = profile.firstName || profile['First Name'] || profile['first_name'] || '';
                const lastName = profile.lastName || profile['Last Name'] || profile['last_name'] || '';
                const company = profile.company || profile['Company'] || profile['company'] || '';
                const key = `${firstName} ${lastName} ${company}`.toLowerCase().trim();
                
                if (!uniqueProfiles.has(key)) {
                    uniqueProfiles.set(key, profile);
                } else {
                    round1Stats.duplicates++;
                }
            });

            const filteredProfiles = Array.from(uniqueProfiles.values()).filter(profile => {
                // Get company and name from various possible field names
                const company = (profile.company || profile['Company'] || profile['company'] || '').toLowerCase();
                const firstName = profile.firstName || profile['First Name'] || profile['first_name'] || '';
                const lastName = profile.lastName || profile['Last Name'] || profile['last_name'] || '';
                const fullName = `${firstName} ${lastName}`.toLowerCase();
                
                // Check blacklist
                if (state.filters.blacklist.some(blacklisted => 
                    blacklisted.trim() && company.includes(blacklisted.toLowerCase().trim())
                )) {
                    round1Stats.filteredOut++;
                    return false;
                }
                
                // Check past candidates
                if (state.filters.pastCandidates.some(candidate => 
                    candidate.trim() && (
                        fullName.includes(candidate.toLowerCase().trim()) || 
                        (profile.raw && JSON.stringify(profile.raw).toLowerCase().includes(candidate.toLowerCase().trim()))
                    )
                )) {
                    round1Stats.filteredOut++;
                    return false;
                }
                
                // Check no-go companies (predefined + custom)
                if (allNoGoCompanies.some(nogo => 
                    nogo.trim() && company.includes(nogo.toLowerCase().trim())
                )) {
                    round1Stats.filteredOut++;
                    return false;
                }
                
                return true;
            });

            round1Stats.remaining = filteredProfiles.length;
            state.profiles = filteredProfiles;

            // Update Round 1 results display
            document.getElementById('round1Uploaded').textContent = round1Stats.uploaded;
            document.getElementById('round1FilteredOut').textContent = round1Stats.filteredOut;
            document.getElementById('round1Remaining').textContent = round1Stats.remaining;
            document.getElementById('round1Duplicates').textContent = round1Stats.duplicates;
            
            // Show results section
            document.getElementById('round1Results').classList.remove('hidden');
            
            // Save Round 1 stats
            localStorage.setItem('scorely_round1_stats', JSON.stringify(round1Stats));
            
            // Show success message
            alert(`Round 1 filtering completed!\nUploaded: ${round1Stats.uploaded}\nFiltered Out: ${round1Stats.filteredOut}\nRemaining: ${round1Stats.remaining}\nDuplicates Removed: ${round1Stats.duplicates}`);
        }

        function proceedToRound2() {
            document.getElementById('profileSummarySection').classList.remove('hidden');
            document.getElementById('advancedFilterSection').classList.remove('hidden');
            
            // Populate column selection if not already done
            if (state.profiles.length > 0) {
                populateColumnSelection();
            }
        }

        function clearDashboard() {
            if (confirm('Are you sure you want to clear the dashboard and reset all filters?')) {
                // Reset all stats
                state.stats = {
                    uploaded: 0,
                    filteredOut: 0,
                    skippedEmbedding: 0,
                    toBeSentToGPT: 0
                };
                
                // Hide all result sections
                document.getElementById('round1Results').classList.add('hidden');
                document.getElementById('round2Results').classList.add('hidden');
                document.getElementById('profileSummarySection').classList.add('hidden');
                document.getElementById('advancedFilterSection').classList.add('hidden');
                
                // Clear localStorage stats
                localStorage.removeItem('scorely_round1_stats');
                localStorage.removeItem('scorely_round2_stats');
                
                alert('Dashboard cleared successfully!');
            }
        }

        function runFilteringRound2() {
            if (state.profiles.length === 0) {
                alert('No profiles to filter. Please complete Round 1 first.');
                return;
            }

            // Save advanced filter settings
            saveAdvancedFilters();

            // Reset Round 2 stats
            const round2Stats = {
                screening: state.profiles.length,
                filteredOut: 0,
                skippedEmbedding: 0,
                toRank: 0
            };

            const filteredProfiles = state.profiles.filter(profile => {
                // Apply advanced filters
                if (!applyAdvancedFilters(profile)) {
                    round2Stats.filteredOut++;
                    return false;
                }
                
                return true;
            });

            round2Stats.toRank = filteredProfiles.length;
            state.profiles = filteredProfiles;
            state.stats.toBeSentToGPT = filteredProfiles.length;

            // Update Round 2 results display
            document.getElementById('round2Screening').textContent = round2Stats.screening;
            document.getElementById('round2FilteredOut').textContent = round2Stats.filteredOut;
            document.getElementById('round2ToRank').textContent = round2Stats.toRank;
            document.getElementById('round2SkippedEmbedding').textContent = round2Stats.skippedEmbedding;
            
            document.getElementById('round2Results').classList.remove('hidden');
            
            // Save Round 2 stats
            localStorage.setItem('scorely_round2_stats', JSON.stringify(round2Stats));
        }

        function setupAdvancedFilterHandlers() {
            // Load saved advanced filter values
            document.getElementById('minYears').value = state.filters.minYears || 0;
            document.getElementById('education').value = state.filters.education.join('\n');
            document.getElementById('essentialSkills').value = state.filters.essentialSkills;
            document.getElementById('suitableRoles').value = state.filters.suitableRoles.join(', ');
            
            // Load red flag settings
            document.getElementById('instability').checked = state.filters.redFlags.instability;
            document.getElementById('stagnation').checked = state.filters.redFlags.stagnation;
            document.getElementById('enterpriseOnly').checked = state.filters.redFlags.enterpriseOnly;
            document.getElementById('freelancer').checked = state.filters.redFlags.freelancer;
        }

        function showColumnMappingModal() {
            if (state.profiles.length === 0) {
                alert('Please upload a file first');
                return;
            }

            const headers = Object.keys(state.profiles[0]);
            const form = document.getElementById('columnMappingForm');
            
            form.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">First Name Column</label>
                        <select id="firstNameCol" class="w-full border border-gray-300 rounded-md p-2">
                            <option value="">Select column...</option>
                            ${headers.map(header => `<option value="${header}">${header}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Last Name Column</label>
                        <select id="lastNameCol" class="w-full border border-gray-300 rounded-md p-2">
                            <option value="">Select column...</option>
                            ${headers.map(header => `<option value="${header}">${header}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Column</label>
                        <select id="companyCol" class="w-full border border-gray-300 rounded-md p-2">
                            <option value="">Select column...</option>
                            ${headers.map(header => `<option value="${header}">${header}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button id="saveMappingBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Save Mapping
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('saveMappingBtn').addEventListener('click', saveColumnMapping);
            document.getElementById('columnMappingModal').style.display = 'block';
        }

        function saveColumnMapping() {
            const firstNameCol = document.getElementById('firstNameCol').value;
            const lastNameCol = document.getElementById('lastNameCol').value;
            const companyCol = document.getElementById('companyCol').value;

            if (!firstNameCol || !lastNameCol || !companyCol) {
                alert('Please select all required columns');
                return;
            }

            state.columnMapping = { firstNameCol, lastNameCol, companyCol };
            
            // Normalize profiles
            state.profiles = state.profiles.map(profile => ({
                firstName: profile[firstNameCol] || '',
                lastName: profile[lastNameCol] || '',
                company: profile[companyCol] || '',
                fullName: `${profile[firstNameCol] || ''} ${profile[lastNameCol] || ''}`.trim(),
                raw: profile
            }));

            localStorage.setItem('scorely_column_mapping', JSON.stringify(state.columnMapping));
            localStorage.setItem('scorely_profiles', JSON.stringify(state.profiles));
            
            document.getElementById('columnMappingModal').style.display = 'none';
            document.getElementById('preFilterSection').classList.remove('hidden');
            document.getElementById('profileSummarySection').classList.remove('hidden');
            
            // Populate column selection
            populateColumnSelection();
            
            alert('Column mapping saved successfully!');
        }

        function populateColumnSelection() {
            if (state.profiles.length === 0) return;
            
            const headers = Object.keys(state.profiles[0].raw);
            const columnSelection = document.getElementById('columnSelection');
            const selectedColumns = JSON.parse(localStorage.getItem('scorely_selected_columns') || '[]');
            
            columnSelection.innerHTML = headers.map(header => `
                <div class="flex items-center">
                    <input type="checkbox" id="col-${header}" value="${header}" 
                           ${selectedColumns.includes(header) ? 'checked' : ''} class="mr-2">
                    <label for="col-${header}" class="text-sm text-gray-700">${header}</label>
                </div>
            `).join('');
        }

        function selectAllColumns() {
            document.querySelectorAll('#columnSelection input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function clearAllColumns() {
            document.querySelectorAll('#columnSelection input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function saveColumnSelection() {
            const selectedColumns = Array.from(document.querySelectorAll('#columnSelection input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            localStorage.setItem('scorely_selected_columns', JSON.stringify(selectedColumns));
            state.selectedColumns = selectedColumns;
            
            alert('Column selection saved!');
            document.getElementById('advancedFilterSection').classList.remove('hidden');
        }

        function runFilteringRound1() {
            if (state.profiles.length === 0) {
                alert('Please upload a file first');
                return;
            }

            // Reset Round 1 stats
            const round1Stats = {
                uploaded: state.profiles.length,
                filteredOut: 0,
                remaining: 0,
                duplicates: 0
            };

            // Get all NO-GO companies (predefined + custom)
            const allNoGoCompanies = [...PREDEFINED_NO_GO_COMPANIES, ...state.filters.noGoCompanies];

            // Deduplicate profiles
            const uniqueProfiles = new Map();
            state.profiles.forEach(profile => {
                // Create a unique key from available fields
                const firstName = profile.firstName || profile['First Name'] || profile['first_name'] || '';
                const lastName = profile.lastName || profile['Last Name'] || profile['last_name'] || '';
                const company = profile.company || profile['Company'] || profile['company'] || '';
                const key = `${firstName} ${lastName} ${company}`.toLowerCase().trim();
                
                if (!uniqueProfiles.has(key)) {
                    uniqueProfiles.set(key, profile);
                } else {
                    round1Stats.duplicates++;
                }
            });

            const filteredProfiles = Array.from(uniqueProfiles.values()).filter(profile => {
                // Get company and name from various possible field names
                const company = (profile.company || profile['Company'] || profile['company'] || '').toLowerCase();
                const firstName = profile.firstName || profile['First Name'] || profile['first_name'] || '';
                const lastName = profile.lastName || profile['Last Name'] || profile['last_name'] || '';
                const fullName = `${firstName} ${lastName}`.toLowerCase();
                
                // Check blacklist
                if (state.filters.blacklist.some(blacklisted => 
                    blacklisted.trim() && company.includes(blacklisted.toLowerCase().trim())
                )) {
                    round1Stats.filteredOut++;
                    return false;
                }
                
                // Check past candidates
                if (state.filters.pastCandidates.some(candidate => 
                    candidate.trim() && (
                        fullName.includes(candidate.toLowerCase().trim()) || 
                        (profile.raw && JSON.stringify(profile.raw).toLowerCase().includes(candidate.toLowerCase().trim()))
                    )
                )) {
                    round1Stats.filteredOut++;
                    return false;
                }
                
                // Check no-go companies (predefined + custom)
                if (allNoGoCompanies.some(nogo => 
                    nogo.trim() && company.includes(nogo.toLowerCase().trim())
                )) {
                    round1Stats.filteredOut++;
                    return false;
                }
                
                return true;
            });

            round1Stats.remaining = filteredProfiles.length;
            state.profiles = filteredProfiles;

            // Update Round 1 results display
            document.getElementById('round1Uploaded').textContent = round1Stats.uploaded;
            document.getElementById('round1FilteredOut').textContent = round1Stats.filteredOut;
            document.getElementById('round1Remaining').textContent = round1Stats.remaining;
            document.getElementById('round1Duplicates').textContent = round1Stats.duplicates;
            
            // Show results section
            document.getElementById('round1Results').classList.remove('hidden');
            
            // Save Round 1 stats
            localStorage.setItem('scorely_round1_stats', JSON.stringify(round1Stats));
            
            // Show success message
            alert(`Round 1 filtering completed!\nUploaded: ${round1Stats.uploaded}\nFiltered Out: ${round1Stats.filteredOut}\nRemaining: ${round1Stats.remaining}\nDuplicates Removed: ${round1Stats.duplicates}`);
        }

        function proceedToRound2() {
            document.getElementById('profileSummarySection').classList.remove('hidden');
            document.getElementById('advancedFilterSection').classList.remove('hidden');
            
            // Populate column selection if not already done
            if (state.profiles.length > 0) {
                populateColumnSelection();
            }
        }

        function clearDashboard() {
            if (confirm('Are you sure you want to clear the dashboard and reset all filters?')) {
                // Reset all stats
                state.stats = {
                    uploaded: 0,
                    filteredOut: 0,
                    skippedEmbedding: 0,
                    toBeSentToGPT: 0
                };
                
                // Hide all result sections
                document.getElementById('round1Results').classList.add('hidden');
                document.getElementById('round2Results').classList.add('hidden');
                document.getElementById('profileSummarySection').classList.add('hidden');
                document.getElementById('advancedFilterSection').classList.add('hidden');
                
                // Clear localStorage stats
                localStorage.removeItem('scorely_round1_stats');
                localStorage.removeItem('scorely_round2_stats');
                
                alert('Dashboard cleared successfully!');
            }
        }

        function runFilteringRound2() {
            if (state.profiles.length === 0) {
                alert('No profiles to filter. Please complete Round 1 first.');
                return;
            }

            // Save advanced filter settings
            saveAdvancedFilters();

            // Reset Round 2 stats
            const round2Stats = {
                screening: state.profiles.length,
                filteredOut: 0,
                skippedEmbedding: 0,
                toRank: 0
            };

            const filteredProfiles = state.profiles.filter(profile => {
                // Apply advanced filters
                if (!applyAdvancedFilters(profile)) {
                    round2Stats.filteredOut++;
                    return false;
                }
                
                return true;
            });

            round2Stats.toRank = filteredProfiles.length;
            state.profiles = filteredProfiles;
            state.stats.toBeSentToGPT = filteredProfiles.length;

            // Update Round 2 results display
            document.getElementById('round2Screening').textContent = round2Stats.screening;
            document.getElementById('round2FilteredOut').textContent = round2Stats.filteredOut;
            document.getElementById('round2ToRank').textContent = round2Stats.toRank;
            document.getElementById('round2SkippedEmbedding').textContent = round2Stats.skippedEmbedding;
            
            document.getElementById('round2Results').classList.remove('hidden');
            
            // Save Round 2 stats
            localStorage.setItem('scorely_round2_stats', JSON.stringify(round2Stats));
        }

        function saveAdvancedFilters() {
            state.filters.minYears = parseInt(document.getElementById('minYears').value) || 0;
            state.filters.education = document.getElementById('education').value.split('\n').filter(line => line.trim());
            state.filters.essentialSkills = document.getElementById('essentialSkills').value;
            state.filters.suitableRoles = document.getElementById('suitableRoles').value.split(',').map(s => s.trim()).filter(s => s);
            
            state.filters.redFlags = {
                instability: document.getElementById('instability').checked,
                stagnation: document.getElementById('stagnation').checked,
                enterpriseOnly: document.getElementById('enterpriseOnly').checked,
                freelancer: document.getElementById('freelancer').checked
            };

            localStorage.setItem('scorely_advanced_filters', JSON.stringify(state.filters));
        }

        function applyAdvancedFilters(profile) {
            // Apply minimum years of experience
            if (state.filters.minYears > 0) {
                // This would need to be extracted from profile data
                // For now, we'll skip this check
            }

            // Apply education filter (predefined + custom) - make it optional
            const allUniversities = [...PREDEFINED_UNIVERSITIES, ...state.filters.education];
            if (allUniversities.length > 0) {
                const profileText = JSON.stringify(profile.raw).toLowerCase();
                const hasEducation = allUniversities.some(uni => 
                    uni.trim() && profileText.includes(uni.toLowerCase().trim())
                );
                // Only filter out if education is required AND not found
                if (!hasEducation && state.filters.education.length > 0) {
                    return false;
                }
            }

            // Apply essential skills filter - make it optional
            if (state.filters.essentialSkills && state.filters.essentialSkills.trim()) {
                const skills = state.filters.essentialSkills.split(',').map(s => s.trim().toLowerCase()).filter(s => s);
                if (skills.length > 0) {
                    const profileText = JSON.stringify(profile.raw).toLowerCase();
                    const hasSkill = skills.some(skill => profileText.includes(skill));
                    if (!hasSkill) return false;
                }
            }

            // Apply suitable roles filter - make it optional
            if (state.filters.suitableRoles.length > 0) {
                const profileText = JSON.stringify(profile.raw).toLowerCase();
                const hasRole = state.filters.suitableRoles.some(role => 
                    role.trim() && profileText.includes(role.toLowerCase().trim())
                );
                if (!hasRole) return false;
            }

            return true;
        }

        function renderRankingView() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="space-y-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Job Configuration</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Job Description</label>
                                <textarea id="jobDescription" rows="4" class="w-full border border-gray-300 rounded-md p-2" 
                                          placeholder="Paste the job description here...">${state.jobConfig.description}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ideal Profile Examples (Optional)</label>
                                <textarea id="idealProfiles" rows="3" class="w-full border border-gray-300 rounded-md p-2" 
                                          placeholder="Paste ideal candidate profiles...">${state.jobConfig.idealProfiles.join('\n\n')}</textarea>
                                <div class="mt-2 flex space-x-2">
                                    <button id="saveIdealProfiles" class="bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 text-sm">
                                        Save Ideal Profiles
                                    </button>
                                    <button id="clearIdealProfiles" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 text-sm">
                                        Clear All
                                    </button>
                                </div>
                                <div id="idealProfilesSaveStatus" class="mt-1 text-xs text-gray-600 hidden">
                                    <span class="text-green-600">✓ Ideal profiles saved!</span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button id="saveJobConfig" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                    Save Job Config
                                </button>
                                <button id="clearJobConfig" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                    Clear All
                                </button>
                            </div>
                            <div id="jobConfigSaveStatus" class="text-sm text-gray-600 hidden">
                                <span class="text-green-600">✓ Job configuration saved successfully!</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Hot Signals & Additional Filters</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium mb-3">Hot Signals</h3>
                                <p class="text-sm text-gray-600 mb-2">Companies experiencing layoffs, closures, etc.</p>
                                <textarea id="hotSignals" rows="4" class="w-full border border-gray-300 rounded-md p-2" 
                                          placeholder="Enter company names, one per line">${state.jobConfig.hotSignals.join('\n')}</textarea>
                                <div class="mt-2 flex space-x-2">
                                    <button id="saveHotSignals" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                        Save Hot Signals
                                    </button>
                                    <button id="clearHotSignals" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                        Clear All
                                    </button>
                                </div>
                                <div id="hotSignalsSaveStatus" class="mt-2 text-sm text-gray-600 hidden">
                                    <span class="text-green-600">✓ Hot signals saved successfully!</span>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-3">Company Size</h3>
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="size1-20" class="mr-2">
                                        <label for="size1-20" class="text-sm text-gray-700">1-20 employees</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="size21-100" class="mr-2">
                                        <label for="size21-100" class="text-sm text-gray-700">21-100 employees</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="size101-500" class="mr-2">
                                        <label for="size101-500" class="text-sm text-gray-700">101-500 employees</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="size500plus" class="mr-2">
                                        <label for="size500plus" class="text-sm text-gray-700">500+ employees</label>
                                    </div>
                                </div>
                                <div class="mt-2 flex space-x-2">
                                    <button id="saveCompanySize" class="bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 text-sm">
                                        Save Company Size
                                    </button>
                                    <button id="clearCompanySize" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 text-sm">
                                        Clear All
                                    </button>
                                </div>
                                <div id="companySizeSaveStatus" class="mt-1 text-xs text-gray-600 hidden">
                                    <span class="text-green-600">✓ Company size saved!</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium mb-3">Industry</h3>
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="industry-tech" class="mr-2">
                                        <label for="industry-tech" class="text-sm text-gray-700">Technology</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="industry-finance" class="mr-2">
                                        <label for="industry-finance" class="text-sm text-gray-700">Finance</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="industry-healthcare" class="mr-2">
                                        <label for="industry-healthcare" class="text-sm text-gray-700">Healthcare</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="industry-fintech" class="mr-2">
                                        <label for="industry-fintech" class="text-sm text-gray-700">Fintech</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="industry-ai" class="mr-2">
                                        <label for="industry-ai" class="text-sm text-gray-700">AI</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="industry-saas" class="mr-2">
                                        <label for="industry-saas" class="text-sm text-gray-700">SAAS</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="industry-data" class="mr-2">
                                        <label for="industry-data" class="text-sm text-gray-700">Data</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="industry-security" class="mr-2">
                                        <label for="industry-security" class="text-sm text-gray-700">Security</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="industry-other" class="mr-2">
                                        <label for="industry-other" class="text-sm text-gray-700">Other</label>
                                    </div>
                                </div>
                                <input type="text" id="customIndustry" class="mt-2 w-full border border-gray-300 rounded-md p-2" 
                                       placeholder="Custom industry">
                                <div class="mt-2 flex space-x-2">
                                    <button id="saveIndustry" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                        Save Industry
                                    </button>
                                    <button id="clearIndustry" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                        Clear All
                                    </button>
                                </div>
                                <div id="industrySaveStatus" class="mt-2 text-sm text-gray-600 hidden">
                                    <span class="text-green-600">✓ Industry settings saved successfully!</span>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-3">Experience Range</h3>
                                <div class="flex items-center space-x-2">
                                    <input type="number" id="minExperience" min="0" max="50" class="w-20 border border-gray-300 rounded-md p-2" 
                                           placeholder="Min" value="${state.jobConfig.experienceRange.min}">
                                    <span class="text-gray-600">to</span>
                                    <input type="number" id="maxExperience" min="0" max="50" class="w-20 border border-gray-300 rounded-md p-2" 
                                           placeholder="Max" value="${state.jobConfig.experienceRange.max}">
                                    <span class="text-gray-600">years</span>
                                </div>
                                <div class="mt-2 flex space-x-2">
                                    <button id="saveExperienceRange" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                        Save Experience Range
                                    </button>
                                    <button id="clearExperienceRange" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                        Clear All
                                    </button>
                                </div>
                                <div id="experienceRangeSaveStatus" class="mt-2 text-sm text-gray-600 hidden">
                                    <span class="text-green-600">✓ Experience range saved successfully!</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <h3 class="text-lg font-medium mb-3">Custom Traits</h3>
                            <div class="mb-3 p-3 bg-blue-50 rounded-lg">
                                <p class="text-sm text-blue-800 mb-2"><strong>What are Custom Traits?</strong></p>
                                <p class="text-sm text-blue-700 mb-2">Custom traits are specific characteristics or qualities you're looking for in candidates. These can include:</p>
                                <ul class="text-sm text-blue-700 space-y-1 ml-4">
                                    <li>• "Has experience with remote teams"</li>
                                    <li>• "Speaks multiple languages"</li>
                                    <li>• "Has worked in early-stage startups"</li>
                                    <li>• "Has international experience"</li>
                                    <li>• "Has led teams of 10+ people"</li>
                                    <li>• "Has experience with agile methodologies"</li>
                                </ul>
                            </div>
                            <div id="customTraitsList" class="space-y-2 mb-3">
                                ${state.jobConfig.customTraits.map(trait => `
                                    <div class="flex items-center space-x-2">
                                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">${trait}</span>
                                        <button class="text-red-600 hover:text-red-800" onclick="removeCustomTrait('${trait}')">×</button>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex space-x-2">
                                <input type="text" id="newCustomTrait" class="flex-1 border border-gray-300 rounded-md p-2" 
                                       placeholder="Enter a custom trait (e.g., 'Has experience with remote teams')">
                                <button id="addCustomTrait" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                    Add Trait
                                </button>
                            </div>
                            <div class="mt-2 flex space-x-2">
                                <button id="saveCustomTraits" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                    Save Traits
                                </button>
                                <button id="clearCustomTraits" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                    Clear All
                                </button>
                            </div>
                            <div id="customTraitsSaveStatus" class="mt-2 text-sm text-gray-600 hidden">
                                <span class="text-green-600">✓ Custom traits saved successfully!</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Ranking Configuration</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium mb-2">Weights</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm text-gray-700">Tech Fit</label>
                                        <input type="range" id="techFitWeight" min="0" max="100" value="${state.jobConfig.weights.techFit}" 
                                               class="w-full">
                                        <span id="techFitValue" class="text-sm text-gray-600">${state.jobConfig.weights.techFit}%</span>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700">Experience</label>
                                        <input type="range" id="experienceWeight" min="0" max="100" value="${state.jobConfig.weights.experience}" 
                                               class="w-full">
                                        <span id="experienceValue" class="text-sm text-gray-600">${state.jobConfig.weights.experience}%</span>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700">Signals</label>
                                        <input type="range" id="signalsWeight" min="0" max="100" value="${state.jobConfig.weights.signals}" 
                                               class="w-full">
                                        <span id="signalsValue" class="text-sm text-gray-600">${state.jobConfig.weights.signals}%</span>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700">Startup Fit</label>
                                        <input type="range" id="startupFitWeight" min="0" max="100" value="${state.jobConfig.weights.startupFit}" 
                                               class="w-full">
                                        <span id="startupFitValue" class="text-sm text-gray-600">${state.jobConfig.weights.startupFit}%</span>
                                    </div>
                                </div>
                                <div class="mt-3 flex space-x-2">
                                    <button id="saveWeights" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                        Save Weights
                                    </button>
                                    <button id="clearWeights" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                        Reset to Default
                                    </button>
                                </div>
                                <div id="weightsSaveStatus" class="mt-2 text-sm text-gray-600 hidden">
                                    <span class="text-green-600">✓ Weights saved successfully!</span>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-2">API Configuration</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm text-gray-700">OpenAI API Key</label>
                                        <input type="password" id="apiKey" value="${state.apiKey}" 
                                               class="w-full border border-gray-300 rounded-md p-2" 
                                               placeholder="sk-...">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700">Embedding Model</label>
                                        <select id="embeddingModelSelect" class="w-full border border-gray-300 rounded-md p-2">
                                            <option value="text-embedding-3-small" ${state.embeddingModel === 'text-embedding-3-small' ? 'selected' : ''}>Embedding Small 3 (Cheapest)</option>
                                            <option value="text-embedding-3-large" ${state.embeddingModel === 'text-embedding-3-large' ? 'selected' : ''}>Embedding Large 3 (More Accurate)</option>
                                            <option value="text-embedding-ada-002" ${state.embeddingModel === 'text-embedding-ada-002' ? 'selected' : ''}>Embedding Ada 002 (Legacy)</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Small 3 is 5x cheaper than Large 3</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700">GPT Model</label>
                                        <select id="gptModelSelect" class="w-full border border-gray-300 rounded-md p-2">
                                            <option value="gpt-3.5-turbo" ${state.gptModel === 'gpt-3.5-turbo' ? 'selected' : ''}>GPT-3.5 Turbo (Cheapest)</option>
                                            <option value="gpt-4o-mini" ${state.gptModel === 'gpt-4o-mini' ? 'selected' : ''}>GPT-4o Mini (Balanced)</option>
                                            <option value="gpt-4o-mini-turbo" ${state.gptModel === 'gpt-4o-mini-turbo' ? 'selected' : ''}>GPT-4o Mini Turbo (Fastest)</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">GPT-3.5 Turbo is 10x cheaper than GPT-4o</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700">Hybrid Mode</label>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="hybridMode" ${state.hybridMode ? 'checked' : ''} class="mr-2">
                                            <span class="text-sm text-gray-600">Use embeddings + GPT for optimal results</span>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Uncheck to save costs (embeddings only)</p>
                                    </div>
                                    <div class="p-3 bg-yellow-50 rounded-lg">
                                        <h4 class="text-sm font-medium text-yellow-800 mb-2">💰 Cost Optimization Tips:</h4>
                                        <ul class="text-xs text-yellow-700 space-y-1">
                                            <li>• Use Embedding Small 3 + GPT-3.5 Turbo for maximum savings</li>
                                            <li>• Disable Hybrid Mode to use embeddings only</li>
                                            <li>• Process profiles in smaller batches (10-20)</li>
                                            <li>• Use pre-filtering to reduce profiles sent to AI</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-3 flex space-x-2">
                                    <button id="saveApiConfig" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                        Save API Config
                                    </button>
                                    <button id="clearApiConfig" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                        Clear All
                                    </button>
                                </div>
                                <div id="apiConfigSaveStatus" class="mt-2 text-sm text-gray-600 hidden">
                                    <span class="text-green-600">✓ API configuration saved successfully!</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Start Ranking</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium mb-3">Ranking Range</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Start from profile</label>
                                        <input type="number" id="rankingStart" min="1" value="1" class="w-full border border-gray-300 rounded-md p-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">End at profile</label>
                                        <input type="number" id="rankingEnd" min="1" class="w-full border border-gray-300 rounded-md p-2">
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        <span id="rankingRangeInfo">Profiles to rank: 0</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-3">Ranking Status</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Profiles to rank:</span>
                                        <span class="text-sm font-medium" id="profilesToRank">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Current progress:</span>
                                        <span class="text-sm font-medium" id="rankingProgress">0 / 0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Ready to start AI-powered ranking</p>
                            </div>
                            <button id="startRankingBtn" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 font-medium">
                                Start Ranking Process
                            </button>
                        </div>
                    </div>

                    <div id="rankingProgress" class="hidden bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Ranking Progress</h2>
                        <div class="space-y-4">
                            <div class="progress-bar">
                                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span id="progressText">Processing...</span>
                                <span id="progressCount">0 / ${state.stats.toBeSentToGPT}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            setupRankingHandlers();
        }

        function setupRankingHandlers() {
            // Weight sliders
            const weightSliders = ['techFit', 'experience', 'signals', 'startupFit'];
            weightSliders.forEach(weight => {
                const slider = document.getElementById(`${weight}Weight`);
                const value = document.getElementById(`${weight}Value`);
                
                slider.addEventListener('input', function() {
                    value.textContent = this.value + '%';
                    state.jobConfig.weights[weight] = parseInt(this.value);
                });
            });

            // API key
            document.getElementById('apiKey').addEventListener('change', function() {
                state.apiKey = this.value;
                localStorage.setItem('scorely_api_key', this.value);
            });

            // Embedding model
            document.getElementById('embeddingModelSelect').addEventListener('change', function() {
                state.embeddingModel = this.value;
                localStorage.setItem('scorely_embedding_model', this.value);
            });

            // GPT model
            document.getElementById('gptModelSelect').addEventListener('change', function() {
                state.gptModel = this.value;
                localStorage.setItem('scorely_gpt_model', this.value);
            });

            // Hybrid mode
            document.getElementById('hybridMode').addEventListener('change', function() {
                state.hybridMode = this.checked;
                localStorage.setItem('scorely_hybrid_mode', this.checked);
            });

            // Ranking range
            const rankingStart = document.getElementById('rankingStart');
            const rankingEnd = document.getElementById('rankingEnd');
            const rankingRangeInfo = document.getElementById('rankingRangeInfo');
            const profilesToRank = document.getElementById('profilesToRank');
            
            // Set default end value
            rankingEnd.value = state.stats.toBeSentToGPT;
            
            function updateRankingRange() {
                const start = parseInt(rankingStart.value) || 1;
                const end = parseInt(rankingEnd.value) || state.stats.toBeSentToGPT;
                const count = Math.max(0, end - start + 1);
                
                rankingRangeInfo.textContent = `Profiles to rank: ${count}`;
                profilesToRank.textContent = count;
                
                state.rankingRange = { start, end, count };
            }
            
            rankingStart.addEventListener('input', updateRankingRange);
            rankingEnd.addEventListener('input', updateRankingRange);
            updateRankingRange();

            // Custom traits
            document.getElementById('addCustomTrait').addEventListener('click', addCustomTrait);
            document.getElementById('newCustomTrait').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addCustomTrait();
            });

            // Start ranking
            document.getElementById('startRankingBtn').addEventListener('click', startRankingProcess);

            // Save buttons
            document.getElementById('saveJobConfig').addEventListener('click', saveJobConfiguration);
            document.getElementById('clearJobConfig').addEventListener('click', clearJobConfiguration);
            
            document.getElementById('saveHotSignals').addEventListener('click', saveHotSignals);
            document.getElementById('clearHotSignals').addEventListener('click', clearHotSignals);
            
            document.getElementById('saveIndustry').addEventListener('click', saveIndustry);
            document.getElementById('clearIndustry').addEventListener('click', clearIndustry);
            
            document.getElementById('saveExperienceRange').addEventListener('click', saveExperienceRange);
            document.getElementById('clearExperienceRange').addEventListener('click', clearExperienceRange);
            
            document.getElementById('saveWeights').addEventListener('click', saveWeights);
            document.getElementById('clearWeights').addEventListener('click', clearWeights);
            
            document.getElementById('saveApiConfig').addEventListener('click', saveApiConfig);
            document.getElementById('clearApiConfig').addEventListener('click', clearApiConfig);
            
            document.getElementById('saveCustomTraits').addEventListener('click', saveCustomTraits);
            document.getElementById('clearCustomTraits').addEventListener('click', clearCustomTraits);
            
            document.getElementById('saveCompanySize').addEventListener('click', saveCompanySize);
            document.getElementById('clearCompanySize').addEventListener('click', clearCompanySize);
        }

        async function startRankingProcess() {
            if (!state.apiKey) {
                alert('Please enter your OpenAI API key');
                return;
            }

            if (state.stats.toBeSentToGPT === 0) {
                alert('No profiles to rank. Please complete the setup process first.');
                return;
            }

            const jobDescription = document.getElementById('jobDescription').value;
            if (!jobDescription.trim()) {
                alert('Please enter a job description');
                return;
            }

            // Save job configuration
            saveJobConfiguration();

            // Get ranking range
            const start = parseInt(document.getElementById('rankingStart').value) || 1;
            const end = parseInt(document.getElementById('rankingEnd').value) || state.stats.toBeSentToGPT;
            const profilesToRank = state.profiles.slice(start - 1, end);

            if (profilesToRank.length === 0) {
                alert('No profiles in the selected range');
                return;
            }

            // Show progress bar and disable start button
            document.getElementById('rankingProgress').classList.remove('hidden');
            document.getElementById('startRankingBtn').disabled = true;
            document.getElementById('startRankingBtn').textContent = 'Ranking in Progress...';

            // Start the ranking process
            await performRanking(profilesToRank);
        }

        async function performRanking(profilesToRank) {
            const totalProfiles = profilesToRank.length;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressCount = document.getElementById('progressCount');

            console.log(`Starting ranking for ${totalProfiles} profiles`);

            // Create profile summaries
            const profilesWithSummaries = profilesToRank.map(profile => ({
                ...profile,
                summary: createProfileSummary(profile),
                fullName: profile.firstName || profile['First Name'] || profile['first_name'] || 'Unknown',
                company: profile.company || profile['Company'] || profile['company'] || 'Unknown'
            }));

            // Batch processing for embeddings
            const batchSize = 20;
            let processedCount = 0;

            for (let i = 0; i < profilesWithSummaries.length; i += batchSize) {
                const batch = profilesWithSummaries.slice(i, i + batchSize);
                
                try {
                    console.log(`Processing batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(profilesWithSummaries.length/batchSize)}`);
                    
                    // Get embeddings for batch
                    const embeddings = await getEmbeddings(batch.map(p => p.summary));
                    
                    // Calculate similarity scores
                    const jobEmbedding = await getEmbeddings([state.jobConfig.description]);
                    
                    batch.forEach((profile, index) => {
                        const similarity = calculateCosineSimilarity(embeddings[index], jobEmbedding[0]);
                        profile.embeddingScore = similarity;
                        
                        if (similarity < EMBEDDING_THRESHOLD) {
                            state.stats.skippedEmbedding++;
                        }
                    });
                    
                    processedCount += batch.length;
                    const progress = (processedCount / totalProfiles) * 100;
                    
                    // Update progress bar
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `Processing batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(profilesWithSummaries.length/batchSize)}...`;
                    progressCount.textContent = `${processedCount} / ${totalProfiles}`;
                    
                    // Force UI update
                    await new Promise(resolve => setTimeout(resolve, 10));
                    
                } catch (error) {
                    console.error('Error processing batch:', error);
                    // Continue with next batch
                }
            }

            console.log('Generating final results...');
            progressText.textContent = 'Generating results...';
            
            // Generate final results
            generateResults(profilesWithSummaries);
            
            progressText.textContent = 'Ranking complete!';
            document.getElementById('startRankingBtn').disabled = false;
            document.getElementById('startRankingBtn').textContent = 'Start Ranking Process';
            
            console.log('Ranking completed, switching to results view');
            
            // Switch to results view
            setTimeout(() => {
                state.currentView = 'results';
                switchView('results');
                updateNavigation();
            }, 1000);
        }

        function saveJobConfiguration() {
            state.jobConfig.description = document.getElementById('jobDescription').value;
            state.jobConfig.idealProfiles = document.getElementById('idealProfiles').value.split('\n\n').filter(p => p.trim());
            state.jobConfig.hotSignals = document.getElementById('hotSignals').value.split('\n').filter(s => s.trim());
            
            // Save company size preferences
            state.jobConfig.companySize = [];
            if (document.getElementById('size1-20').checked) state.jobConfig.companySize.push('1-20');
            if (document.getElementById('size21-100').checked) state.jobConfig.companySize.push('21-100');
            if (document.getElementById('size101-500').checked) state.jobConfig.companySize.push('101-500');
            if (document.getElementById('size500plus').checked) state.jobConfig.companySize.push('500+');
            
            // Save industry preferences
            state.jobConfig.industry = [];
            if (document.getElementById('industry-tech').checked) state.jobConfig.industry.push('Technology');
            if (document.getElementById('industry-finance').checked) state.jobConfig.industry.push('Finance');
            if (document.getElementById('industry-healthcare').checked) state.jobConfig.industry.push('Healthcare');
            if (document.getElementById('industry-fintech').checked) state.jobConfig.industry.push('Fintech');
            if (document.getElementById('industry-ai').checked) state.jobConfig.industry.push('AI');
            if (document.getElementById('industry-saas').checked) state.jobConfig.industry.push('SAAS');
            if (document.getElementById('industry-data').checked) state.jobConfig.industry.push('Data');
            if (document.getElementById('industry-security').checked) state.jobConfig.industry.push('Security');
            if (document.getElementById('industry-other').checked) state.jobConfig.industry.push('Other');
            
            const customIndustry = document.getElementById('customIndustry').value.trim();
            if (customIndustry) state.jobConfig.industry.push(customIndustry);
            
            // Save experience range
            state.jobConfig.experienceRange = {
                min: parseInt(document.getElementById('minExperience').value) || 0,
                max: parseInt(document.getElementById('maxExperience').value) || 50
            };
            
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
        }

        function clearJobConfiguration() {
            document.getElementById('jobDescription').value = '';
            document.getElementById('idealProfiles').value = '';
            state.jobConfig.description = '';
            state.jobConfig.idealProfiles = [];
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('jobConfigSaveStatus', 1500);
        }

        function saveHotSignals() {
            state.jobConfig.hotSignals = document.getElementById('hotSignals').value.split('\n').filter(s => s.trim());
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('hotSignalsSaveStatus', 1500);
        }

        function clearHotSignals() {
            document.getElementById('hotSignals').value = '';
            state.jobConfig.hotSignals = [];
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('hotSignalsSaveStatus', 1500);
        }

        function saveIndustry() {
            state.jobConfig.industry = [];
            if (document.getElementById('industry-tech').checked) state.jobConfig.industry.push('Technology');
            if (document.getElementById('industry-finance').checked) state.jobConfig.industry.push('Finance');
            if (document.getElementById('industry-healthcare').checked) state.jobConfig.industry.push('Healthcare');
            if (document.getElementById('industry-fintech').checked) state.jobConfig.industry.push('Fintech');
            if (document.getElementById('industry-ai').checked) state.jobConfig.industry.push('AI');
            if (document.getElementById('industry-saas').checked) state.jobConfig.industry.push('SAAS');
            if (document.getElementById('industry-data').checked) state.jobConfig.industry.push('Data');
            if (document.getElementById('industry-security').checked) state.jobConfig.industry.push('Security');
            if (document.getElementById('industry-other').checked) state.jobConfig.industry.push('Other');
            
            const customIndustry = document.getElementById('customIndustry').value.trim();
            if (customIndustry) state.jobConfig.industry.push(customIndustry);
            
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('industrySaveStatus', 1500);
        }

        function clearIndustry() {
            // Uncheck all checkboxes
            ['industry-tech', 'industry-finance', 'industry-healthcare', 'industry-fintech', 
             'industry-ai', 'industry-saas', 'industry-data', 'industry-security', 'industry-other'].forEach(id => {
                document.getElementById(id).checked = false;
            });
            document.getElementById('customIndustry').value = '';
            state.jobConfig.industry = [];
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('industrySaveStatus', 1500);
        }

        function saveExperienceRange() {
            state.jobConfig.experienceRange = {
                min: parseInt(document.getElementById('minExperience').value) || 0,
                max: parseInt(document.getElementById('maxExperience').value) || 50
            };
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('experienceRangeSaveStatus', 1500);
        }

        function clearExperienceRange() {
            document.getElementById('minExperience').value = '0';
            document.getElementById('maxExperience').value = '50';
            state.jobConfig.experienceRange = { min: 0, max: 50 };
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('experienceRangeSaveStatus', 1500);
        }

        function saveWeights() {
            state.jobConfig.weights.techFit = parseInt(document.getElementById('techFitWeight').value);
            state.jobConfig.weights.experience = parseInt(document.getElementById('experienceWeight').value);
            state.jobConfig.weights.signals = parseInt(document.getElementById('signalsWeight').value);
            state.jobConfig.weights.startupFit = parseInt(document.getElementById('startupFitWeight').value);
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('weightsSaveStatus', 1500);
        }

        function clearWeights() {
            // Reset to default weights
            const defaultWeights = { techFit: 30, experience: 25, signals: 25, startupFit: 20 };
            state.jobConfig.weights = defaultWeights;
            
            document.getElementById('techFitWeight').value = defaultWeights.techFit;
            document.getElementById('experienceWeight').value = defaultWeights.experience;
            document.getElementById('signalsWeight').value = defaultWeights.signals;
            document.getElementById('startupFitWeight').value = defaultWeights.startupFit;
            
            document.getElementById('techFitValue').textContent = defaultWeights.techFit + '%';
            document.getElementById('experienceValue').textContent = defaultWeights.experience + '%';
            document.getElementById('signalsValue').textContent = defaultWeights.signals + '%';
            document.getElementById('startupFitValue').textContent = defaultWeights.startupFit + '%';
            
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('weightsSaveStatus', 1500);
        }

        function saveApiConfig() {
            state.apiKey = document.getElementById('apiKey').value;
            state.embeddingModel = document.getElementById('embeddingModelSelect').value;
            state.gptModel = document.getElementById('gptModelSelect').value;
            state.hybridMode = document.getElementById('hybridMode').checked;
            
            localStorage.setItem('scorely_api_key', state.apiKey);
            localStorage.setItem('scorely_embedding_model', state.embeddingModel);
            localStorage.setItem('scorely_gpt_model', state.gptModel);
            localStorage.setItem('scorely_hybrid_mode', state.hybridMode);
            
            showSaveStatus('apiConfigSaveStatus', 1500);
        }

        function clearApiConfig() {
            document.getElementById('apiKey').value = '';
            document.getElementById('embeddingModelSelect').value = 'text-embedding-3-small';
            document.getElementById('gptModelSelect').value = 'gpt-3.5-turbo';
            document.getElementById('hybridMode').checked = false;
            
            state.apiKey = '';
            state.embeddingModel = 'text-embedding-3-small';
            state.gptModel = 'gpt-3.5-turbo';
            state.hybridMode = false;
            
            localStorage.removeItem('scorely_api_key');
            localStorage.setItem('scorely_embedding_model', state.embeddingModel);
            localStorage.setItem('scorely_gpt_model', state.gptModel);
            localStorage.setItem('scorely_hybrid_mode', state.hybridMode);
            
            showSaveStatus('apiConfigSaveStatus', 1500);
        }

        function saveCustomTraits() {
            // Custom traits are already saved in the addCustomTrait function
            showSaveStatus('customTraitsSaveStatus', 1500);
        }

        function clearCustomTraits() {
            if (confirm('Are you sure you want to clear all custom traits?')) {
                state.jobConfig.customTraits = [];
                localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
                renderRankingView(); // Refresh to show empty list
                showSaveStatus('customTraitsSaveStatus', 1500);
            }
        }

        function showSaveStatus(elementId) {
            const statusElement = document.getElementById(elementId);
            statusElement.classList.remove('hidden');
            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, 3000);
        }

        function createProfileSummary(profile) {
            console.log('Creating summary for profile:', profile);
            
            // Check if profile has raw data
            if (!profile.raw) {
                console.warn('Profile has no raw data:', profile);
                return JSON.stringify(profile);
            }
            
            // Check if selected columns exist
            if (!state.selectedColumns || state.selectedColumns.length === 0) {
                console.log('No selected columns, using all columns');
                // Use all columns if none selected
                return Object.values(profile.raw).join(' ');
            }
            
            console.log('Selected columns:', state.selectedColumns);
            console.log('Profile raw data:', profile.raw);
            
            const summary = state.selectedColumns.map(col => {
                const value = profile.raw[col] || '';
                console.log(`Column ${col}: ${value}`);
                return value;
            }).join(' ');
            
            console.log('Generated summary:', summary);
            return summary;
        }

        async function getEmbeddings(texts) {
            if (!state.apiKey) {
                throw new Error('API key not configured');
            }

            try {
                const response = await fetch('https://api.openai.com/v1/embeddings', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        input: texts,
                        model: state.embeddingModel
                    })
                });

                if (!response.ok) {
                    throw new Error(`Embedding API error: ${response.status}`);
                }

                const data = await response.json();
                return data.data.map(item => item.embedding);
            } catch (error) {
                console.error('Embedding error:', error);
                // Return mock embeddings for demo
                return texts.map(() => Array(1536).fill(0).map(() => Math.random()));
            }
        }

        function calculateCosineSimilarity(vecA, vecB) {
            const dotProduct = vecA.reduce((sum, a, i) => sum + a * vecB[i], 0);
            const normA = Math.sqrt(vecA.reduce((sum, a) => sum + a * a, 0));
            const normB = Math.sqrt(vecB.reduce((sum, b) => sum + b * b, 0));
            return dotProduct / (normA * normB);
        }

        function generateResults(profilesWithSummaries) {
            console.log('Generating results for profiles:', profilesWithSummaries.length);
            
            // Sort by embedding score
            const sortedProfiles = profilesWithSummaries
                .filter(p => p.embeddingScore >= EMBEDDING_THRESHOLD)
                .sort((a, b) => b.embeddingScore - a.embeddingScore);

            console.log(`Profiles after embedding filter: ${sortedProfiles.length}`);

            // Generate mock AI scores for demo
            const scoredProfiles = sortedProfiles.map(profile => {
                const baseScore = profile.embeddingScore * 100;
                const randomFactor = 0.8 + Math.random() * 0.4; // ±20% variation
                const finalScore = Math.min(100, Math.max(0, baseScore * randomFactor));
                
                return {
                    ...profile,
                    score: finalScore,
                    strengths: generateMockStrengths(profile),
                    concerns: generateMockConcerns(profile),
                    category: getCategory(finalScore)
                };
            });

            console.log(`Scored profiles: ${scoredProfiles.length}`);

            // Categorize results
            state.results = {
                top: scoredProfiles.filter(p => p.score >= 85),
                good: scoredProfiles.filter(p => p.score >= 70 && p.score < 85),
                hidden: scoredProfiles.filter(p => p.score < 70),
                hotSignals: scoredProfiles.filter(p => 
                    state.jobConfig.hotSignals && state.jobConfig.hotSignals.some(signal => 
                        signal && p.company && p.company.toLowerCase().includes(signal.toLowerCase())
                    )
                )
            };

            console.log('Results categorized:', {
                top: state.results.top.length,
                good: state.results.good.length,
                hidden: state.results.hidden.length,
                hotSignals: state.results.hotSignals.length
            });

            // Save results to localStorage
            localStorage.setItem('scorely_results', JSON.stringify(state.results));
            console.log('Results saved to localStorage');
        }

        function generateMockStrengths(profile) {
            const strengths = [
                'Strong technical background',
                'Relevant industry experience',
                'Good educational background',
                'Proven track record',
                'Excellent communication skills'
            ];
            return strengths.slice(0, 2 + Math.floor(Math.random() * 2));
        }

        function generateMockConcerns(profile) {
            const concerns = [
                'Limited startup experience',
                'May be overqualified',
                'Needs development in specific areas',
                'Cultural fit questions',
                'Salary expectations may be high'
            ];
            return concerns.slice(0, 1 + Math.floor(Math.random() * 2));
        }

        function getCategory(score) {
            if (score >= 85) return 'TOP';
            if (score >= 70) return 'GOOD';
            return 'HIDDEN';
        }

        function renderResultsView() {
            // Load results from localStorage if they exist
            const savedResults = localStorage.getItem('scorely_results');
            if (savedResults && !state.results.top.length && !state.results.good.length && !state.results.hidden.length) {
                try {
                    state.results = JSON.parse(savedResults);
                    console.log('Loaded results from localStorage:', state.results);
                } catch (error) {
                    console.error('Error loading results from localStorage:', error);
                }
            }

            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="space-y-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Ranking Results</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <div class="text-2xl font-bold text-green-600">${state.results.top.length}</div>
                                <div class="text-sm text-gray-600">Top Candidates</div>
                            </div>
                            <div class="text-center p-4 bg-yellow-50 rounded-lg">
                                <div class="text-2xl font-bold text-yellow-600">${state.results.good.length}</div>
                                <div class="text-sm text-gray-600">Good Candidates</div>
                            </div>
                            <div class="text-center p-4 bg-purple-50 rounded-lg">
                                <div class="text-2xl font-bold text-purple-600">${state.results.hidden.length}</div>
                                <div class="text-sm text-gray-600">Hidden Gems</div>
                            </div>
                            <div class="text-center p-4 bg-red-50 rounded-lg">
                                <div class="text-2xl font-bold text-red-600">${state.results.hotSignals.length}</div>
                                <div class="text-sm text-gray-600">Hot Signals</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex space-x-4 mb-4">
                            <button class="tab-btn px-4 py-2 rounded-md font-medium" data-tab="top">TOP (${state.results.top.length})</button>
                            <button class="tab-btn px-4 py-2 rounded-md font-medium" data-tab="good">GOOD (${state.results.good.length})</button>
                            <button class="tab-btn px-4 py-2 rounded-md font-medium" data-tab="hidden">HIDDEN GEM (${state.results.hidden.length})</button>
                            <button class="tab-btn px-4 py-2 rounded-md font-medium" data-tab="hot">HOT SIGNALS (${state.results.hotSignals.length})</button>
                        </div>
                        
                        <div id="resultsContent">
                            <!-- Results will be rendered here -->
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Feedback System</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium mb-3">Overall Feedback</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-4">
                                        <button class="feedback-btn bg-green-100 text-green-800 px-3 py-2 rounded-md hover:bg-green-200" data-feedback="accurate">
                                            Accurate
                                        </button>
                                        <button class="feedback-btn bg-red-100 text-red-800 px-3 py-2 rounded-md hover:bg-red-200" data-feedback="inaccurate">
                                            Inaccurate
                                        </button>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <button class="feedback-btn bg-yellow-100 text-yellow-800 px-3 py-2 rounded-md hover:bg-yellow-200" data-feedback="too-high">
                                            Too High
                                        </button>
                                        <button class="feedback-btn bg-blue-100 text-blue-800 px-3 py-2 rounded-md hover:bg-blue-200" data-feedback="too-low">
                                            Too Low
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-3">Criteria Feedback</h3>
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="feedback-experience" class="mr-2">
                                        <label for="feedback-experience" class="text-sm text-gray-700">Experience assessment</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="feedback-education" class="mr-2">
                                        <label for="feedback-education" class="text-sm text-gray-700">Education evaluation</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="feedback-skills" class="mr-2">
                                        <label for="feedback-skills" class="text-sm text-gray-700">Skills matching</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="feedback-culture" class="mr-2">
                                        <label for="feedback-culture" class="text-sm text-gray-700">Culture fit</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <h3 class="text-lg font-medium mb-3">Quantitative Rating</h3>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm text-gray-700">Overall Quality:</span>
                                <div class="flex space-x-1">
                                    ${[1,2,3,4,5].map(num => `
                                        <button class="rating-btn w-8 h-8 rounded-full border border-gray-300 hover:bg-blue-100" data-rating="${num}">
                                            ${num}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <h3 class="text-lg font-medium mb-3">Qualitative Comments</h3>
                            <textarea id="feedbackComments" rows="3" class="w-full border border-gray-300 rounded-md p-2" 
                                      placeholder="Share your thoughts on the ranking quality..."></textarea>
                        </div>
                        
                        <div class="mt-4 flex space-x-4">
                            <button id="submitFeedback" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                Submit Feedback
                            </button>
                            <button id="viewFeedbackStats" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                                View Feedback Stats
                            </button>
                        </div>
                    </div>

                    <div id="feedbackStatsModal" class="modal">
                        <div class="modal-content">
                            <span class="close">&times;</span>
                            <h2 class="text-lg font-semibold mb-4">Feedback Statistics</h2>
                            <div id="feedbackStatsContent">
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="text-center p-4 bg-green-50 rounded-lg">
                                        <div class="text-2xl font-bold text-green-600" id="accurateCount">0</div>
                                        <div class="text-sm text-gray-600">Accurate</div>
                                    </div>
                                    <div class="text-center p-4 bg-red-50 rounded-lg">
                                        <div class="text-2xl font-bold text-red-600" id="inaccurateCount">0</div>
                                        <div class="text-sm text-gray-600">Inaccurate</div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h3 class="font-medium mb-2">Average Rating</h3>
                                    <div class="text-2xl font-bold text-blue-600" id="avgRating">0.0</div>
                                </div>
                                <div>
                                    <h3 class="font-medium mb-2">Recent Feedback Trends</h3>
                                    <canvas id="feedbackChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            setupResultsHandlers();
            showResultsTab('top'); // Default to top tab
        }

        function setupResultsHandlers() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
                    this.classList.add('tab-active');
                    showResultsTab(this.dataset.tab);
                });
            });

            // Set up feedback handlers
            document.querySelectorAll('.feedback-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
                    this.classList.add('bg-blue-500', 'text-white');
                });
            });

            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
                    this.classList.add('bg-blue-500', 'text-white');
                });
            });

            document.getElementById('submitFeedback').addEventListener('click', submitFeedback);
            document.getElementById('viewFeedbackStats').addEventListener('click', showFeedbackStats);
        }

        function showResultsTab(tabName) {
            console.log(`Showing tab: ${tabName}`);
            console.log('Available results:', state.results);
            
            const resultsContent = document.getElementById('resultsContent');
            const candidates = state.results[tabName] || [];
            
            console.log(`Candidates for ${tabName}:`, candidates.length);
            
            if (candidates.length === 0) {
                resultsContent.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>No candidates in this category.</p>
                        <p class="text-sm mt-2">Try running the ranking process first.</p>
                    </div>
                `;
                return;
            }

            resultsContent.innerHTML = candidates.map(candidate => `
                <div class="border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-medium text-lg">${candidate.fullName || 'Unknown Name'}</h3>
                            <p class="text-gray-600">${candidate.company || 'Unknown Company'}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-blue-600">${Math.round(candidate.score || 0)}</div>
                            <div class="text-sm text-gray-500">Score</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <h4 class="font-medium text-green-700 mb-1">Strengths:</h4>
                            <ul class="text-sm text-gray-700">
                                ${(candidate.strengths || []).map(s => `<li>• ${s}</li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-medium text-red-700 mb-1">Concerns:</h4>
                            <ul class="text-sm text-gray-700">
                                ${(candidate.concerns || []).map(c => `<li>• ${c}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="px-2 py-1 rounded text-xs font-medium ${
                            candidate.category === 'TOP' ? 'bg-green-100 text-green-800' :
                            candidate.category === 'GOOD' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-purple-100 text-purple-800'
                        }">${candidate.category || 'UNKNOWN'}</span>
                        <button onclick="showCandidateDetail('${candidate.fullName || 'Unknown'}')" 
                                class="text-blue-600 hover:text-blue-800 text-sm">
                            View Details
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function submitFeedback() {
            const feedback = {
                timestamp: new Date().toISOString(),
                overall: getSelectedFeedback(),
                criteria: getSelectedCriteria(),
                rating: getSelectedRating(),
                comments: document.getElementById('feedbackComments').value
            };

            // Save feedback
            const feedbackHistory = JSON.parse(localStorage.getItem('scorely_feedback') || '[]');
            feedbackHistory.push(feedback);
            localStorage.setItem('scorely_feedback', JSON.stringify(feedbackHistory));

            // Analyze feedback for learning
            analyzeFeedback(feedback);

            alert('Feedback submitted successfully!');
            
            // Clear form
            document.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('bg-blue-500', 'text-white'));
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('feedbackComments').value = '';
        }

        function getSelectedFeedback() {
            const selectedBtn = document.querySelector('.feedback-btn.bg-blue-500');
            return selectedBtn ? selectedBtn.dataset.feedback : null;
        }

        function getSelectedCriteria() {
            const criteria = [];
            if (document.getElementById('feedback-experience').checked) criteria.push('experience');
            if (document.getElementById('feedback-education').checked) criteria.push('education');
            if (document.getElementById('feedback-skills').checked) criteria.push('skills');
            if (document.getElementById('feedback-culture').checked) criteria.push('culture');
            return criteria;
        }

        function getSelectedRating() {
            const selectedBtn = document.querySelector('.rating-btn.bg-blue-500');
            return selectedBtn ? parseInt(selectedBtn.dataset.rating) : null;
        }

        function analyzeFeedback(feedback) {
            // Simple feedback analysis
            if (feedback.overall === 'inaccurate' || feedback.rating < 3) {
                // Adjust thresholds or weights
                console.log('Feedback indicates issues - consider adjusting parameters');
            }
        }

        function showFeedbackStats() {
            const feedbackHistory = JSON.parse(localStorage.getItem('scorely_feedback') || '[]');
            
            const accurateCount = feedbackHistory.filter(f => f.overall === 'accurate').length;
            const inaccurateCount = feedbackHistory.filter(f => f.overall === 'inaccurate').length;
            const ratings = feedbackHistory.filter(f => f.rating).map(f => f.rating);
            const avgRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : '0.0';
            
            document.getElementById('accurateCount').textContent = accurateCount;
            document.getElementById('inaccurateCount').textContent = inaccurateCount;
            document.getElementById('avgRating').textContent = avgRating;
            
            document.getElementById('feedbackStatsModal').style.display = 'block';
        }

        function showCandidateDetail(fullName) {
            const candidate = [...state.results.top, ...state.results.good, ...state.results.hidden, ...state.results.hotSignals]
                .find(c => c.fullName === fullName);
            
            if (!candidate) return;

            const modalContent = document.getElementById('detailModalContent');
            modalContent.innerHTML = `
                <h2 class="text-xl font-semibold mb-4">${candidate.fullName}</h2>
                <div class="space-y-4">
                    <div>
                        <strong>Company:</strong> ${candidate.company}
                    </div>
                    <div>
                        <strong>Score:</strong> ${Math.round(candidate.score)}
                    </div>
                    <div>
                        <strong>Category:</strong> ${candidate.category}
                    </div>
                    <div>
                        <strong>Embedding Score:</strong> ${candidate.embeddingScore ? (candidate.embeddingScore * 100).toFixed(1) : 'N/A'}
                    </div>
                    <div>
                        <strong>Strengths:</strong>
                        <ul class="list-disc list-inside mt-1">
                            ${candidate.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                    <div>
                        <strong>Concerns:</strong>
                        <ul class="list-disc list-inside mt-1">
                            ${candidate.concerns.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;

            document.getElementById('detailModal').style.display = 'block';
        }

        function resetSession() {
            if (confirm('Are you sure you want to reset the session? This will clear all data.')) {
                localStorage.clear();
                location.reload();
            }
        }

        function addCustomTrait() {
            const input = document.getElementById('newCustomTrait');
            const trait = input.value.trim();
            
            if (trait && !state.jobConfig.customTraits.includes(trait)) {
                state.jobConfig.customTraits.push(trait);
                localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
                renderRankingView(); // Refresh to show new trait
                showSaveStatus('customTraitsSaveStatus', 1500);
            }
            
            input.value = '';
        }

        function removeCustomTrait(trait) {
            state.jobConfig.customTraits = state.jobConfig.customTraits.filter(t => t !== trait);
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            renderRankingView(); // Refresh to remove trait
            showSaveStatus('customTraitsSaveStatus', 1500);
        }

        // Make functions globally available for onclick handlers
        window.showCandidateDetail = showCandidateDetail;
        window.removeCustomTrait = removeCustomTrait;

        function saveBlacklist() {
            state.filters.blacklist = document.getElementById('blacklist').value.split('\n').filter(line => line.trim());
            localStorage.setItem('scorely_blacklist', JSON.stringify(state.filters.blacklist));
            showSaveStatus('blacklistSaveStatus', 1500);
        }

        function clearBlacklist() {
            document.getElementById('blacklist').value = '';
            state.filters.blacklist = [];
            localStorage.removeItem('scorely_blacklist');
            showSaveStatus('blacklistSaveStatus', 1500);
        }

        function savePastCandidates() {
            state.filters.pastCandidates = document.getElementById('pastCandidates').value.split('\n').filter(line => line.trim());
            localStorage.setItem('scorely_past_candidates', JSON.stringify(state.filters.pastCandidates));
            showSaveStatus('pastCandidatesSaveStatus', 1500);
        }

        function clearPastCandidates() {
            document.getElementById('pastCandidates').value = '';
            state.filters.pastCandidates = [];
            localStorage.removeItem('scorely_past_candidates');
            showSaveStatus('pastCandidatesSaveStatus', 1500);
        }

        function saveNoGoCompanies() {
            state.filters.noGoCompanies = document.getElementById('noGoCompanies').value.split('\n').filter(line => line.trim());
            localStorage.setItem('scorely_nogo_companies', JSON.stringify(state.filters.noGoCompanies));
            showSaveStatus('noGoCompaniesSaveStatus', 1500);
        }

        function clearNoGoCompanies() {
            document.getElementById('noGoCompanies').value = '';
            state.filters.noGoCompanies = [];
            localStorage.removeItem('scorely_nogo_companies');
            showSaveStatus('noGoCompaniesSaveStatus', 1500);
        }

        function saveBasicThresholds() {
            state.filters.minYears = parseInt(document.getElementById('minYears').value) || 0;
            state.filters.education = document.getElementById('education').value.split('\n').filter(line => line.trim());
            state.filters.essentialSkills = document.getElementById('essentialSkills').value;
            state.filters.suitableRoles = document.getElementById('suitableRoles').value.split(',').map(s => s.trim()).filter(s => s);
            
            localStorage.setItem('scorely_advanced_filters', JSON.stringify(state.filters));
            showSaveStatus('basicThresholdsSaveStatus', 1500);
        }

        function clearBasicThresholds() {
            document.getElementById('minYears').value = '0';
            document.getElementById('education').value = '';
            document.getElementById('essentialSkills').value = '';
            document.getElementById('suitableRoles').value = '';
            
            state.filters.minYears = 0;
            state.filters.education = [];
            state.filters.essentialSkills = '';
            state.filters.suitableRoles = [];
            
            localStorage.setItem('scorely_advanced_filters', JSON.stringify(state.filters));
            showSaveStatus('basicThresholdsSaveStatus', 1500);
        }

        function saveRedFlags() {
            state.filters.redFlags = {
                instability: document.getElementById('instability').checked,
                stagnation: document.getElementById('stagnation').checked,
                enterpriseOnly: document.getElementById('enterpriseOnly').checked,
                freelancer: document.getElementById('freelancer').checked
            };
            localStorage.setItem('scorely_advanced_filters', JSON.stringify(state.filters));
            showSaveStatus('redFlagsSaveStatus', 1500);
        }

        function clearRedFlags() {
            document.getElementById('instability').checked = false;
            document.getElementById('stagnation').checked = false;
            document.getElementById('enterpriseOnly').checked = false;
            document.getElementById('freelancer').checked = false;
            
            state.filters.redFlags = {
                instability: false,
                stagnation: false,
                enterpriseOnly: false,
                freelancer: false
            };
            localStorage.setItem('scorely_advanced_filters', JSON.stringify(state.filters));
            showSaveStatus('redFlagsSaveStatus', 1500);
        }

        function saveEssentialSkills() {
            state.filters.essentialSkills = document.getElementById('essentialSkills').value;
            localStorage.setItem('scorely_advanced_filters', JSON.stringify(state.filters));
            showSaveStatus('essentialSkillsSaveStatus', 1500);
        }

        function clearEssentialSkills() {
            document.getElementById('essentialSkills').value = '';
            state.filters.essentialSkills = '';
            localStorage.setItem('scorely_advanced_filters', JSON.stringify(state.filters));
            showSaveStatus('essentialSkillsSaveStatus', 1500);
        }

        function saveIdealProfiles() {
            state.jobConfig.idealProfiles = document.getElementById('idealProfiles').value.split('\n\n').filter(p => p.trim());
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('idealProfilesSaveStatus', 1500);
        }

        function clearIdealProfiles() {
            document.getElementById('idealProfiles').value = '';
            state.jobConfig.idealProfiles = [];
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('idealProfilesSaveStatus', 1500);
        }

        // Make functions globally accessible
        window.switchView = switchView;
        window.showCandidateDetail = showCandidateDetail;
        window.removeCustomTrait = removeCustomTrait;
        window.saveBlacklist = saveBlacklist;
        window.clearBlacklist = clearBlacklist;
        window.savePastCandidates = savePastCandidates;
        window.clearPastCandidates = clearPastCandidates;
        window.saveNoGoCompanies = saveNoGoCompanies;
        window.clearNoGoCompanies = clearNoGoCompanies;
        window.saveBasicThresholds = saveBasicThresholds;
        window.clearBasicThresholds = clearBasicThresholds;
        window.saveRedFlags = saveRedFlags;
        window.clearRedFlags = clearRedFlags;
        window.saveJobConfiguration = saveJobConfiguration;
        window.clearJobConfiguration = clearJobConfiguration;
        window.saveHotSignals = saveHotSignals;
        window.clearHotSignals = clearHotSignals;
        window.saveIndustry = saveIndustry;
        window.clearIndustry = clearIndustry;
        window.saveExperienceRange = saveExperienceRange;
        window.clearExperienceRange = clearExperienceRange;
        window.saveWeights = saveWeights;
        window.clearWeights = clearWeights;
        window.saveApiConfig = saveApiConfig;
        window.clearApiConfig = clearApiConfig;
        window.saveCustomTraits = saveCustomTraits;
        window.clearCustomTraits = clearCustomTraits;
        window.saveCompanySize = saveCompanySize;
        window.clearCompanySize = clearCompanySize;
        window.showResultsTab = showResultsTab;
        window.submitFeedback = submitFeedback;
        window.showFeedbackStats = showFeedbackStats;
        window.runFilteringRound1 = runFilteringRound1;
        window.runFilteringRound2 = runFilteringRound2;
        window.startRanking = startRankingProcess;
        window.addCustomTrait = addCustomTrait;
        window.removeCustomTrait = removeCustomTrait;
        window.addPredefinedNoGo = addPredefinedNoGo;
        window.addPredefinedEducation = addPredefinedEducation;
        window.proceedToRound2 = proceedToRound2;
        window.clearDashboard = clearDashboard;
        window.showColumnMappingModal = showColumnMappingModal;
        window.saveColumnMapping = saveColumnMapping;
        window.selectAllColumns = selectAllColumns;
        window.clearAllColumns = clearAllColumns;
        window.saveColumnSelection = saveColumnSelection;
        window.setupAdvancedFilterHandlers = setupAdvancedFilterHandlers;
        window.navigatePrevious = navigatePrevious;
        window.navigateNext = navigateNext;
        window.resetSession = resetSession;

        function saveCompanySize() {
            state.jobConfig.companySize = [];
            if (document.getElementById('size1-20').checked) state.jobConfig.companySize.push('1-20');
            if (document.getElementById('size21-100').checked) state.jobConfig.companySize.push('21-100');
            if (document.getElementById('size101-500').checked) state.jobConfig.companySize.push('101-500');
            if (document.getElementById('size500plus').checked) state.jobConfig.companySize.push('500+');
            
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('companySizeSaveStatus', 1500);
        }

        function clearCompanySize() {
            document.getElementById('size1-20').checked = false;
            document.getElementById('size21-100').checked = false;
            document.getElementById('size101-500').checked = false;
            document.getElementById('size500plus').checked = false;
            
            state.jobConfig.companySize = [];
            localStorage.setItem('scorely_job_config', JSON.stringify(state.jobConfig));
            showSaveStatus('companySizeSaveStatus', 1500);
        }

        window.submitFeedback = submitFeedback;
        window.getSelectedFeedback = getSelectedFeedback;
        window.getSelectedCriteria = getSelectedCriteria;
        window.getSelectedRating = getSelectedRating;
        window.analyzeFeedback = analyzeFeedback;
        window.createProfileSummary = createProfileSummary;
        window.getEmbeddings = getEmbeddings;
        window.calculateCosineSimilarity = calculateCosineSimilarity;
        window.generateResults = generateResults;
        window.generateMockStrengths = generateMockStrengths;
        window.generateMockConcerns = generateMockConcerns;
        window.getCategory = getCategory;
        window.clearRedFlags = clearRedFlags;
        window.saveEssentialSkills = saveEssentialSkills;
        window.clearEssentialSkills = clearEssentialSkills;
        window.saveIdealProfiles = saveIdealProfiles;
        window.clearIdealProfiles = clearIdealProfiles;
        window.showResultsTab = showResultsTab;
        window.setupResultsHandlers = setupResultsHandlers;
    </script>
</body>
</html> 
