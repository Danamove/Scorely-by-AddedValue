<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scorely - AI-Powered LinkedIn Profile Ranking</title>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        
        .candidate-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        
        .candidate-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .score-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .score-top { background-color: #dcfce7; color: #166534; }
        .score-good { background-color: #fef3c7; color: #92400e; }
        .score-hidden { background-color: #f3e8ff; color: #7c3aed; }
        .score-hot { background-color: #fee2e2; color: #dc2626; }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">Scorely</h1>
                    <span class="ml-2 text-sm text-gray-500">AI-Powered Profile Ranking</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="nav-setup" class="nav-tab px-3 py-2 rounded-md text-sm font-medium">Setup</button>
                    <button id="nav-ranking" class="nav-tab px-3 py-2 rounded-md text-sm font-medium">Ranking</button>
                    <button id="nav-results" class="nav-tab px-3 py-2 rounded-md text-sm font-medium">Results</button>
                    <button id="reset-session" class="px-3 py-2 rounded-md text-sm font-medium text-red-600 hover:bg-red-50">Reset Session</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main App Container -->
    <div id="app" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <!-- Modals -->
    <div id="columnMappingModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-lg font-semibold mb-4">Map CSV Columns</h2>
            <div id="columnMappingForm"></div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="detailModalContent"></div>
        </div>
    </div>

    <script>
        // Global State Management
        const state = {
            currentView: 'setup',
            apiKey: localStorage.getItem('scorely_api_key') || '',
            embeddingModel: localStorage.getItem('scorely_embedding_model') || 'text-embedding-3-small',
            gptModel: localStorage.getItem('scorely_gpt_model') || 'gpt-4o-mini',
            hybridMode: localStorage.getItem('scorely_hybrid_mode') !== 'false', // Default to true
            profiles: [],
            columnMapping: {},
            filters: {
                blacklist: JSON.parse(localStorage.getItem('scorely_blacklist') || '[]'),
                pastCandidates: JSON.parse(localStorage.getItem('scorely_past_candidates') || '[]'),
                noGoCompanies: JSON.parse(localStorage.getItem('scorely_nogo_companies') || '[]'),
                minYears: 0,
                education: [],
                essentialSkills: '',
                suitableRoles: [],
                redFlags: {
                    instability: false,
                    stagnation: false,
                    enterpriseOnly: false,
                    freelancer: false
                }
            },
            jobConfig: {
                description: '',
                idealProfiles: [],
                hotSignals: [],
                companySize: [],
                industry: [],
                experienceRange: { min: 0, max: 50 },
                excellenceBadges: [],
                customTraits: [],
                weights: {
                    techFit: 25,
                    experience: 25,
                    signals: 25,
                    startupFit: 25
                }
            },
            results: {
                top: [],
                good: [],
                hidden: [],
                hotSignals: []
            },
            stats: {
                uploaded: 0,
                filteredOut: 0,
                skippedEmbedding: 0,
                toBeSentToGPT: 0
            }
        };

        // Constants
        const ROLE_SYNONYMS = {
            'software engineer': ['developer', 'programmer', 'coder', 'engineer'],
            'product manager': ['pm', 'product owner', 'product lead'],
            'data scientist': ['ml engineer', 'ai engineer', 'analyst'],
            'designer': ['ux designer', 'ui designer', 'product designer']
        };

        const EMBEDDING_THRESHOLD = 0.7;

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Set up navigation
            document.getElementById('nav-setup').addEventListener('click', () => switchView('setup'));
            document.getElementById('nav-ranking').addEventListener('click', () => switchView('ranking'));
            document.getElementById('nav-results').addEventListener('click', () => switchView('results'));
            document.getElementById('reset-session').addEventListener('click', resetSession);

            // Set up modal close handlers
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });

            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });

            // Load initial view
            switchView('setup');
        }

        function switchView(view) {
            state.currentView = view;
            
            // Update navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('tab-active');
            });
            document.getElementById(`nav-${view}`).classList.add('tab-active');

            // Render view
            switch(view) {
                case 'setup':
                    renderSetupView();
                    break;
                case 'ranking':
                    renderRankingView();
                    break;
                case 'results':
                    renderResultsView();
                    break;
            }
        }

        function renderSetupView() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="space-y-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">1. Upload Profile Data</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Upload CSV or Excel file
                                </label>
                                <input type="file" id="fileInput" accept=".csv,.xlsx" 
                                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                            <div id="uploadStatus" class="hidden">
                                <p class="text-sm text-gray-600">Processing file...</p>
                            </div>
                        </div>
                    </div>

                    <div id="columnMappingSection" class="hidden bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">2. Map Columns</h2>
                        <button id="mapColumnsBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Map CSV Columns
                        </button>
                    </div>

                    <div id="preFilterSection" class="hidden bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">3. Pre-Filter Configuration</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <h3 class="text-lg font-medium mb-2">Blacklist Companies</h3>
                                <textarea id="blacklist" rows="4" class="w-full border border-gray-300 rounded-md p-2" 
                                          placeholder="Enter company names, one per line"></textarea>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-2">Past Candidates</h3>
                                <textarea id="pastCandidates" rows="4" class="w-full border border-gray-300 rounded-md p-2" 
                                          placeholder="Enter names or LinkedIn URLs"></textarea>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-2">No-Go Companies</h3>
                                <textarea id="noGoCompanies" rows="4" class="w-full border border-gray-300 rounded-md p-2" 
                                          placeholder="Enter company names"></textarea>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-4">
                            <button id="saveFiltersBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                Save Filters
                            </button>
                            <button id="runFilteringBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                Run Filtering
                            </button>
                        </div>
                    </div>

                    <div id="filterResults" class="hidden bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Filter Results</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600">${state.stats.uploaded}</div>
                                <div class="text-sm text-gray-600">Uploaded</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-600">${state.stats.filteredOut}</div>
                                <div class="text-sm text-gray-600">Filtered Out</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-600">${state.stats.skippedEmbedding}</div>
                                <div class="text-sm text-gray-600">Skipped</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600">${state.stats.toBeSentToGPT}</div>
                                <div class="text-sm text-gray-600">To Rank</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Set up event listeners
            setupFileUpload();
            setupFilterHandlers();
        }

        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileUpload);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.classList.remove('hidden');
            uploadStatus.innerHTML = '<p class="text-sm text-gray-600">Processing file...</p>';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let profiles = [];
                    const fileName = file.name.toLowerCase();
                    
                    if (fileName.endsWith('.csv')) {
                        profiles = parseCSV(e.target.result);
                    } else if (fileName.endsWith('.xlsx')) {
                        profiles = parseXLSX(e.target.result);
                    }

                    state.profiles = profiles;
                    state.stats.uploaded = profiles.length;
                    
                    uploadStatus.innerHTML = `<p class="text-sm text-green-600">Successfully loaded ${profiles.length} profiles</p>`;
                    document.getElementById('columnMappingSection').classList.remove('hidden');
                    
                } catch (error) {
                    uploadStatus.innerHTML = `<p class="text-sm text-red-600">Error processing file: ${error.message}</p>`;
                }
            };
            
            reader.readAsText(file);
        }

        function parseCSV(content) {
            const results = Papa.parse(content, {
                header: true,
                skipEmptyLines: true
            });
            
            if (results.errors.length > 0) {
                throw new Error('CSV parsing errors: ' + results.errors.map(e => e.message).join(', '));
            }
            
            return results.data;
        }

        function parseXLSX(content) {
            const workbook = XLSX.read(content, { type: 'binary' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            if (data.length < 2) {
                throw new Error('Excel file must have at least a header row and one data row');
            }
            
            const headers = data[0];
            const rows = data.slice(1);
            
            return rows.map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index] || '';
                });
                return obj;
            });
        }

        function setupFilterHandlers() {
            // Load existing filter data
            document.getElementById('blacklist').value = state.filters.blacklist.join('\n');
            document.getElementById('pastCandidates').value = state.filters.pastCandidates.join('\n');
            document.getElementById('noGoCompanies').value = state.filters.noGoCompanies.join('\n');

            // Set up save and run buttons
            document.getElementById('saveFiltersBtn').addEventListener('click', saveFilters);
            document.getElementById('runFilteringBtn').addEventListener('click', runFiltering);
            document.getElementById('mapColumnsBtn').addEventListener('click', showColumnMappingModal);
        }

        function saveFilters() {
            state.filters.blacklist = document.getElementById('blacklist').value.split('\n').filter(line => line.trim());
            state.filters.pastCandidates = document.getElementById('pastCandidates').value.split('\n').filter(line => line.trim());
            state.filters.noGoCompanies = document.getElementById('noGoCompanies').value.split('\n').filter(line => line.trim());
            
            localStorage.setItem('scorely_blacklist', JSON.stringify(state.filters.blacklist));
            localStorage.setItem('scorely_past_candidates', JSON.stringify(state.filters.pastCandidates));
            localStorage.setItem('scorely_nogo_companies', JSON.stringify(state.filters.noGoCompanies));
            
            alert('Filters saved successfully!');
        }

        function runFiltering() {
            if (state.profiles.length === 0) {
                alert('Please upload a file first');
                return;
            }

            // Reset stats
            state.stats.filteredOut = 0;
            state.stats.skippedEmbedding = 0;
            state.stats.toBeSentToGPT = 0;

            // Deduplicate profiles
            const uniqueProfiles = new Map();
            state.profiles.forEach(profile => {
                const key = `${profile.firstName || ''} ${profile.lastName || ''} ${profile.company || ''}`.toLowerCase();
                if (!uniqueProfiles.has(key)) {
                    uniqueProfiles.set(key, profile);
                }
            });

            const filteredProfiles = Array.from(uniqueProfiles.values()).filter(profile => {
                const company = (profile.company || '').toLowerCase();
                const fullName = `${profile.firstName || ''} ${profile.lastName || ''}`.toLowerCase();
                
                // Check blacklist
                if (state.filters.blacklist.some(blacklisted => company.includes(blacklisted.toLowerCase()))) {
                    state.stats.filteredOut++;
                    return false;
                }
                
                // Check past candidates
                if (state.filters.pastCandidates.some(candidate => 
                    fullName.includes(candidate.toLowerCase()) || 
                    (profile.raw && profile.raw.includes(candidate))
                )) {
                    state.stats.filteredOut++;
                    return false;
                }
                
                // Check no-go companies
                if (state.filters.noGoCompanies.some(nogo => company.includes(nogo.toLowerCase()))) {
                    state.stats.filteredOut++;
                    return false;
                }
                
                return true;
            });

            state.profiles = filteredProfiles;
            state.stats.toBeSentToGPT = filteredProfiles.length;
            
            document.getElementById('filterResults').classList.remove('hidden');
            renderSetupView(); // Refresh to show updated stats
        }

        function showColumnMappingModal() {
            if (state.profiles.length === 0) {
                alert('Please upload a file first');
                return;
            }

            const headers = Object.keys(state.profiles[0]);
            const form = document.getElementById('columnMappingForm');
            
            form.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">First Name Column</label>
                        <select id="firstNameCol" class="w-full border border-gray-300 rounded-md p-2">
                            <option value="">Select column...</option>
                            ${headers.map(header => `<option value="${header}">${header}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Last Name Column</label>
                        <select id="lastNameCol" class="w-full border border-gray-300 rounded-md p-2">
                            <option value="">Select column...</option>
                            ${headers.map(header => `<option value="${header}">${header}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Column</label>
                        <select id="companyCol" class="w-full border border-gray-300 rounded-md p-2">
                            <option value="">Select column...</option>
                            ${headers.map(header => `<option value="${header}">${header}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button id="saveMappingBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Save Mapping
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('saveMappingBtn').addEventListener('click', saveColumnMapping);
            document.getElementById('columnMappingModal').style.display = 'block';
        }

        function saveColumnMapping() {
            const firstNameCol = document.getElementById('firstNameCol').value;
            const lastNameCol = document.getElementById('lastNameCol').value;
            const companyCol = document.getElementById('companyCol').value;

            if (!firstNameCol || !lastNameCol || !companyCol) {
                alert('Please select all required columns');
                return;
            }

            state.columnMapping = { firstNameCol, lastNameCol, companyCol };
            
            // Normalize profiles
            state.profiles = state.profiles.map(profile => ({
                firstName: profile[firstNameCol] || '',
                lastName: profile[lastNameCol] || '',
                company: profile[companyCol] || '',
                fullName: `${profile[firstNameCol] || ''} ${profile[lastNameCol] || ''}`.trim(),
                raw: profile
            }));

            localStorage.setItem('scorely_column_mapping', JSON.stringify(state.columnMapping));
            localStorage.setItem('scorely_profiles', JSON.stringify(state.profiles));
            
            document.getElementById('columnMappingModal').style.display = 'none';
            document.getElementById('preFilterSection').classList.remove('hidden');
            
            alert('Column mapping saved successfully!');
        }

        function renderRankingView() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="space-y-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Job Configuration</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Job Description</label>
                                <textarea id="jobDescription" rows="4" class="w-full border border-gray-300 rounded-md p-2" 
                                          placeholder="Paste the job description here...">${state.jobConfig.description}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ideal Profile Examples (Optional)</label>
                                <textarea id="idealProfiles" rows="3" class="w-full border border-gray-300 rounded-md p-2" 
                                          placeholder="Paste ideal candidate profiles...">${state.jobConfig.idealProfiles.join('\n\n')}</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Ranking Configuration</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium mb-2">Weights</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm text-gray-700">Tech Fit</label>
                                        <input type="range" id="techFitWeight" min="0" max="100" value="${state.jobConfig.weights.techFit}" 
                                               class="w-full">
                                        <span id="techFitValue" class="text-sm text-gray-600">${state.jobConfig.weights.techFit}%</span>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700">Experience</label>
                                        <input type="range" id="experienceWeight" min="0" max="100" value="${state.jobConfig.weights.experience}" 
                                               class="w-full">
                                        <span id="experienceValue" class="text-sm text-gray-600">${state.jobConfig.weights.experience}%</span>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700">Signals</label>
                                        <input type="range" id="signalsWeight" min="0" max="100" value="${state.jobConfig.weights.signals}" 
                                               class="w-full">
                                        <span id="signalsValue" class="text-sm text-gray-600">${state.jobConfig.weights.signals}%</span>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700">Startup Fit</label>
                                        <input type="range" id="startupFitWeight" min="0" max="100" value="${state.jobConfig.weights.startupFit}" 
                                               class="w-full">
                                        <span id="startupFitValue" class="text-sm text-gray-600">${state.jobConfig.weights.startupFit}%</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-2">API Configuration</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm text-gray-700">OpenAI API Key</label>
                                        <input type="password" id="apiKey" value="${state.apiKey}" 
                                               class="w-full border border-gray-300 rounded-md p-2" 
                                               placeholder="sk-...">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700">Embedding Model</label>
                                        <select id="embeddingModelSelect" class="w-full border border-gray-300 rounded-md p-2">
                                            <option value="text-embedding-3-small" ${state.embeddingModel === 'text-embedding-3-small' ? 'selected' : ''}>Embedding Small 3</option>
                                            <option value="text-embedding-3-large" ${state.embeddingModel === 'text-embedding-3-large' ? 'selected' : ''}>Embedding Large 3</option>
                                            <option value="text-embedding-ada-002" ${state.embeddingModel === 'text-embedding-ada-002' ? 'selected' : ''}>Embedding Ada 002</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700">GPT Model</label>
                                        <select id="gptModelSelect" class="w-full border border-gray-300 rounded-md p-2">
                                            <option value="gpt-4o-mini" ${state.gptModel === 'gpt-4o-mini' ? 'selected' : ''}>GPT-4o Mini</option>
                                            <option value="gpt-4o-mini-turbo" ${state.gptModel === 'gpt-4o-mini-turbo' ? 'selected' : ''}>GPT-4o Mini Turbo</option>
                                            <option value="gpt-3.5-turbo" ${state.gptModel === 'gpt-3.5-turbo' ? 'selected' : ''}>GPT-3.5 Turbo</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-700">Hybrid Mode</label>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="hybridMode" ${state.hybridMode ? 'checked' : ''} class="mr-2">
                                            <span class="text-sm text-gray-600">Use embeddings + GPT for optimal results</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Start Ranking</h2>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Profiles to rank: <span class="font-semibold">${state.stats.toBeSentToGPT}</span></p>
                                <p class="text-sm text-gray-600">Estimated cost: <span class="font-semibold">$${(state.stats.toBeSentToGPT * 0.01).toFixed(2)}</span></p>
                            </div>
                            <button id="startRankingBtn" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 font-medium">
                                Start Ranking Process
                            </button>
                        </div>
                    </div>

                    <div id="rankingProgress" class="hidden bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Ranking Progress</h2>
                        <div class="space-y-4">
                            <div class="progress-bar">
                                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span id="progressText">Processing...</span>
                                <span id="progressCount">0 / ${state.stats.toBeSentToGPT}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            setupRankingHandlers();
        }

        function setupRankingHandlers() {
            // Weight sliders
            const weightSliders = ['techFit', 'experience', 'signals', 'startupFit'];
            weightSliders.forEach(weight => {
                const slider = document.getElementById(`${weight}Weight`);
                const value = document.getElementById(`${weight}Value`);
                
                slider.addEventListener('input', function() {
                    value.textContent = this.value + '%';
                    state.jobConfig.weights[weight] = parseInt(this.value);
                });
            });

            // API key
            document.getElementById('apiKey').addEventListener('change', function() {
                state.apiKey = this.value;
                localStorage.setItem('scorely_api_key', this.value);
            });

            // Embedding model
            document.getElementById('embeddingModelSelect').addEventListener('change', function() {
                state.embeddingModel = this.value;
                localStorage.setItem('scorely_embedding_model', this.value);
            });

            // GPT model
            document.getElementById('gptModelSelect').addEventListener('change', function() {
                state.gptModel = this.value;
                localStorage.setItem('scorely_gpt_model', this.value);
            });

            // Hybrid mode
            document.getElementById('hybridMode').addEventListener('change', function() {
                state.hybridMode = this.checked;
                localStorage.setItem('scorely_hybrid_mode', this.checked);
            });

            // Start ranking
            document.getElementById('startRankingBtn').addEventListener('click', startRankingProcess);
        }

        async function startRankingProcess() {
            if (!state.apiKey) {
                alert('Please enter your OpenAI API key');
                return;
            }

            if (state.stats.toBeSentToGPT === 0) {
                alert('No profiles to rank. Please complete the setup process first.');
                return;
            }

            const jobDescription = document.getElementById('jobDescription').value;
            if (!jobDescription.trim()) {
                alert('Please enter a job description');
                return;
            }

            state.jobConfig.description = jobDescription;
            state.jobConfig.idealProfiles = document.getElementById('idealProfiles').value.split('\n\n').filter(p => p.trim());

            document.getElementById('rankingProgress').classList.remove('hidden');
            document.getElementById('startRankingBtn').disabled = true;

            // Simulate ranking process (replace with actual AI calls)
            await simulateRankingProcess();
        }

        async function simulateRankingProcess() {
            const totalProfiles = state.stats.toBeSentToGPT;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressCount = document.getElementById('progressCount');

            for (let i = 0; i < totalProfiles; i++) {
                await new Promise(resolve => setTimeout(resolve, 100)); // Simulate processing time
                
                const progress = ((i + 1) / totalProfiles) * 100;
                progressFill.style.width = progress + '%';
                progressText.textContent = `Ranking profile ${i + 1}...`;
                progressCount.textContent = `${i + 1} / ${totalProfiles}`;
            }

            // Generate mock results
            generateMockResults();
            
            progressText.textContent = 'Ranking complete!';
            document.getElementById('startRankingBtn').disabled = false;
            
            // Switch to results view
            setTimeout(() => switchView('results'), 1000);
        }

        function generateMockResults() {
            const profiles = state.profiles.slice(0, state.stats.toBeSentToGPT);
            
            state.results = {
                top: profiles.slice(0, Math.floor(profiles.length * 0.2)).map((profile, index) => ({
                    ...profile,
                    score: 85 + Math.random() * 15,
                    strengths: ['Strong technical background', 'Relevant experience'],
                    concerns: ['May be overqualified'],
                    category: 'TOP'
                })),
                good: profiles.slice(Math.floor(profiles.length * 0.2), Math.floor(profiles.length * 0.6)).map((profile, index) => ({
                    ...profile,
                    score: 70 + Math.random() * 15,
                    strengths: ['Good fit for role'],
                    concerns: ['Limited startup experience'],
                    category: 'GOOD'
                })),
                hidden: profiles.slice(Math.floor(profiles.length * 0.6)).map((profile, index) => ({
                    ...profile,
                    score: 50 + Math.random() * 20,
                    strengths: ['Potential upside'],
                    concerns: ['Needs development'],
                    category: 'HIDDEN'
                })),
                hotSignals: []
            };
        }

        function renderResultsView() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="space-y-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Ranking Results</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <div class="text-2xl font-bold text-green-600">${state.results.top.length}</div>
                                <div class="text-sm text-gray-600">Top Candidates</div>
                            </div>
                            <div class="text-center p-4 bg-yellow-50 rounded-lg">
                                <div class="text-2xl font-bold text-yellow-600">${state.results.good.length}</div>
                                <div class="text-sm text-gray-600">Good Candidates</div>
                            </div>
                            <div class="text-center p-4 bg-purple-50 rounded-lg">
                                <div class="text-2xl font-bold text-purple-600">${state.results.hidden.length}</div>
                                <div class="text-sm text-gray-600">Hidden Gems</div>
                            </div>
                            <div class="text-center p-4 bg-red-50 rounded-lg">
                                <div class="text-2xl font-bold text-red-600">${state.results.hotSignals.length}</div>
                                <div class="text-sm text-gray-600">Hot Signals</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex space-x-4 mb-4">
                            <button class="tab-btn px-4 py-2 rounded-md font-medium" data-tab="top">TOP (${state.results.top.length})</button>
                            <button class="tab-btn px-4 py-2 rounded-md font-medium" data-tab="good">GOOD (${state.results.good.length})</button>
                            <button class="tab-btn px-4 py-2 rounded-md font-medium" data-tab="hidden">HIDDEN GEM (${state.results.hidden.length})</button>
                            <button class="tab-btn px-4 py-2 rounded-md font-medium" data-tab="hot">HOT SIGNALS (${state.results.hotSignals.length})</button>
                        </div>
                        
                        <div id="resultsContent">
                            <!-- Results will be rendered here -->
                        </div>
                    </div>
                </div>
            `;

            setupResultsHandlers();
            showResultsTab('top'); // Default to top tab
        }

        function setupResultsHandlers() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
                    this.classList.add('tab-active');
                    showResultsTab(this.dataset.tab);
                });
            });
        }

        function showResultsTab(tab) {
            const content = document.getElementById('resultsContent');
            const candidates = state.results[tab] || [];
            
            if (candidates.length === 0) {
                content.innerHTML = '<p class="text-gray-500 text-center py-8">No candidates in this category</p>';
                return;
            }

            content.innerHTML = candidates.map(candidate => `
                <div class="candidate-card">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-lg font-semibold">${candidate.fullName}</h3>
                            <p class="text-gray-600">${candidate.company}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="score-badge score-${candidate.category.toLowerCase()}">${Math.round(candidate.score)}</span>
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" 
                                    onclick="showCandidateDetail('${candidate.fullName}')">VIEW</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <strong>Strengths:</strong>
                            <ul class="list-disc list-inside text-gray-600">
                                ${candidate.strengths.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <strong>Concerns:</strong>
                            <ul class="list-disc list-inside text-gray-600">
                                ${candidate.concerns.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showCandidateDetail(fullName) {
            const candidate = [...state.results.top, ...state.results.good, ...state.results.hidden, ...state.results.hotSignals]
                .find(c => c.fullName === fullName);
            
            if (!candidate) return;

            const modalContent = document.getElementById('detailModalContent');
            modalContent.innerHTML = `
                <h2 class="text-xl font-semibold mb-4">${candidate.fullName}</h2>
                <div class="space-y-4">
                    <div>
                        <strong>Company:</strong> ${candidate.company}
                    </div>
                    <div>
                        <strong>Score:</strong> ${Math.round(candidate.score)}
                    </div>
                    <div>
                        <strong>Category:</strong> ${candidate.category}
                    </div>
                    <div>
                        <strong>Strengths:</strong>
                        <ul class="list-disc list-inside mt-1">
                            ${candidate.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                    <div>
                        <strong>Concerns:</strong>
                        <ul class="list-disc list-inside mt-1">
                            ${candidate.concerns.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;

            document.getElementById('detailModal').style.display = 'block';
        }

        function resetSession() {
            if (confirm('Are you sure you want to reset the session? This will clear all data.')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Make functions globally available for onclick handlers
        window.showCandidateDetail = showCandidateDetail;
    </script>
</body>
</html> 
